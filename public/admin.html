<!DOCTYPE html>
<html>
<head>
  <title>ATC24 Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .admin-login {
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      background: var(--background-color);
      transition: opacity 0.5s ease, visibility 0.5s ease;
    }

    .admin-login.fade-out {
      opacity: 0;
      visibility: hidden;
      display: none;
    }

    .admin-container {
      display: block;
      opacity: 0;
      visibility: hidden;
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
      transition: opacity 0.5s ease 0.5s, visibility 0.5s ease 0.5s;
    }

    .admin-container.authenticated {
      opacity: 1;
      visibility: visible;
    }

    .login-box {
      background: var(--surface-color);
      border-radius: 16px;
      padding: 40px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }

    .admin-header {
      text-align: center;
      margin-bottom: 40px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .admin-nav {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 12px 24px;
      background: var(--surface-hover);
      border: 2px solid var(--border-color);
      color: var(--text-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .nav-btn:hover,
    .nav-btn.active {
      background: var(--primary-color);
      color: #000;
      border-color: var(--primary-color);
    }

    .admin-section {
      display: none;
    }

    .admin-section.active {
      display: block;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .analytics-card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 25px;
      text-align: center;
      transition: all 0.3s ease;
    }

    .analytics-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-hover);
      border-color: rgba(245, 222, 64, 0.3);
    }

    .analytics-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 8px;
    }

    .analytics-label {
      font-size: 14px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 30px;
    }

    .settings-group {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 25px;
    }

    .settings-group h3 {
      color: var(--primary-color);
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }

    .setting-item {
      margin-bottom: 20px;
    }

    .setting-item:last-child {
      margin-bottom: 0;
    }

    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary-color);
    }

    .checkbox-item label {
      color: var(--text-color);
      font-size: 14px;
      cursor: pointer;
    }

    .danger-zone {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      border-radius: 12px;
      padding: 25px;
      margin-top: 30px;
    }

    .danger-zone h3 {
      color: #ff6b6b;
      margin-bottom: 15px;
    }

    .danger-btn {
      background: #ff6b6b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .danger-btn:hover {
      background: #ff5252;
      transform: translateY(-1px);
    }

    .logout-btn {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--surface-hover);
      border: 2px solid var(--border-color);
      color: var(--text-color);
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: #ff6b6b;
      border-color: #ff6b6b;
      color: white;
    }

    .chart-container {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 25px;
      margin-top: 20px;
      height: 400px;
      position: relative;
    }

    .chart-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .chart-header h3 {
      color: var(--primary-color);
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 5px 0;
    }

    .chart-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin: 0;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
      width: 100%;
    }

    .chart-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 300px;
      color: var(--text-muted);
      font-style: italic;
    }

    .save-settings-btn {
      width: 100%;
      margin-top: 20px;
    }

    /* Override input styling to match main page beautiful design */
    .admin-container select,
    .admin-container textarea,
    .admin-container input[type="text"],
    .admin-container input[type="number"],
    .admin-container input[type="password"],
    .login-box select,
    .login-box textarea,
    .login-box input[type="text"],
    .login-box input[type="number"],
    .login-box input[type="password"] {
      width: 100%;
      padding: 15px;
      background: var(--surface-hover);
      border: 2px solid var(--border-color);
      border-radius: 10px;
      color: var(--text-color);
      font-size: 14px;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      z-index: 1;
    }

    .admin-container select {
      appearance: none;
      background-image: url('data:image/svg+xml;charset=US-ASCII,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 4 5"><path fill="%23f5de40" d="M2 0L0 2h4zm0 5L0 3h4z"/></svg>');
      background-repeat: no-repeat;
      background-position: right 15px center;
      background-size: 12px;
      padding-right: 45px;
    }

    .admin-container select:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(245, 222, 64, 0.1);
      background: rgba(245, 222, 64, 0.02);
      transform: translateY(-1px);
      z-index: 200;
    }

    .admin-container select option {
      background: var(--surface-hover) !important;
      color: var(--text-color) !important;
      padding: 10px 15px;
      border: none;
    }

    .admin-container select option:hover,
    .admin-container select option:focus {
      background: var(--primary-color) !important;
      background-color: #f5de40 !important;
      color: #000 !important;
    }

    .admin-container select option:selected {
      background: var(--primary-color) !important;
      background-color: #f5de40 !important;
      color: #000 !important;
    }

    .admin-container textarea:focus,
    .admin-container input[type="text"]:focus,
    .admin-container input[type="number"]:focus,
    .admin-container input[type="password"]:focus,
    .login-box textarea:focus,
    .login-box input[type="text"]:focus,
    .login-box input[type="number"]:focus,
    .login-box input[type="password"]:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(245, 222, 64, 0.1);
      background: rgba(245, 222, 64, 0.02);
      transform: translateY(-1px);
    }

    .admin-container textarea {
      resize: vertical;
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
      line-height: 1.6;
      min-height: 120px;
    }

    .admin-container input[type="text"]::placeholder,
    .admin-container input[type="number"]::placeholder,
    .admin-container input[type="password"]::placeholder,
    .admin-container textarea::placeholder,
    .login-box input[type="text"]::placeholder,
    .login-box input[type="number"]::placeholder,
    .login-box input[type="password"]::placeholder,
    .login-box textarea::placeholder {
      color: var(--text-muted);
      font-style: italic;
    }

    /* Special styling for phraseology template textarea */
    #phraseologyTemplate {
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
      font-size: 13px;
      line-height: 1.5;
      min-height: 140px;
    }

    /* Notification Popup System */
    .notification-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .notification-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .notification-popup {
      background: var(--surface-color);
      border: 2px solid var(--border-color);
      border-radius: 16px;
      padding: 40px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow);
      transform: scale(0.8) translateY(20px);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .notification-overlay.show .notification-popup {
      transform: scale(1) translateY(0);
    }

    .notification-popup::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--primary-color), #ffd700);
    }

    .notification-icon {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      margin: 0 auto 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: bold;
      color: #fff;
      position: relative;
      overflow: hidden;
    }

    .notification-icon.success {
      background: linear-gradient(135deg, #4CAF50, #45a049);
      box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
    }

    .notification-icon.error {
      background: linear-gradient(135deg, #f44336, #d32f2f);
      box-shadow: 0 4px 15px rgba(244, 67, 54, 0.3);
    }

    .notification-icon.warning {
      background: linear-gradient(135deg, #ff9800, #f57c00);
      box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }

    .notification-icon.info {
      background: linear-gradient(135deg, var(--primary-color), #ffd700);
      box-shadow: 0 4px 15px rgba(245, 222, 64, 0.3);
    }

    .notification-title {
      color: var(--text-color);
      font-size: 22px;
      font-weight: 600;
      margin-bottom: 12px;
      letter-spacing: -0.02em;
    }

    .notification-message {
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 30px;
    }

    .notification-close-btn {
      background: linear-gradient(135deg, var(--primary-color), #ffd700);
      border: none;
      border-radius: 10px;
      padding: 14px 32px;
      color: #000;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      position: relative;
      overflow: hidden;
    }

    .notification-close-btn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }

    .notification-close-btn:hover::before {
      left: 100%;
    }

    .notification-close-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(245, 222, 64, 0.4);
    }

    .notification-close-btn:active {
      transform: translateY(0);
    }

    /* Success specific styling */
    .notification-popup.success {
      border-color: rgba(76, 175, 80, 0.3);
    }

    .notification-popup.success::before {
      background: linear-gradient(90deg, #4CAF50, #45a049);
    }

    /* Error specific styling */
    .notification-popup.error {
      border-color: rgba(244, 67, 54, 0.3);
    }

    .notification-popup.error::before {
      background: linear-gradient(90deg, #f44336, #d32f2f);
    }

    /* Close button on top right */
    .notification-close-x {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 18px;
      cursor: pointer;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .notification-close-x:hover {
      background: var(--surface-hover);
      color: var(--text-color);
    }

    /* Tables Section Styles */
    .table-nav {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .table-nav-btn {
      padding: 10px 16px;
      background: var(--surface-hover);
      border: 2px solid var(--border-color);
      color: var(--text-color);
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table-nav-btn:hover,
    .table-nav-btn.active {
      background: var(--primary-color);
      color: #000;
      border-color: var(--primary-color);
    }

    .table-container {
      background: var(--surface-hover);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 0;
      overflow: hidden;
      max-height: 600px;
      overflow-y: auto;
    }

    .table-loading {
      padding: 40px;
      text-align: center;
      color: var(--text-muted);
      font-style: italic;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    .data-table th {
      background: var(--background-color);
      color: var(--primary-color);
      padding: 12px 8px;
      text-align: left;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid var(--border-color);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .data-table td {
      padding: 10px 8px;
      border-bottom: 1px solid var(--border-color);
      color: var(--text-color);
      word-break: break-word;
      max-width: 200px;
    }

    .data-table tr:nth-child(even) {
      background: rgba(255, 255, 255, 0.02);
    }

    .data-table tr:hover {
      background: rgba(245, 222, 64, 0.05);
    }

    .table-cell-truncated {
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .table-cell-truncated:hover {
      color: var(--primary-color);
      text-overflow: clip;
      white-space: normal;
      max-width: none;
    }

    .table-pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 15px;
      margin-top: 15px;
    }

    .current-users-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 15px;
    }

    .user-card {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      transition: all 0.3s ease;
    }

    .user-card:hover {
      border-color: rgba(245, 222, 64, 0.3);
      transform: translateY(-2px);
    }

    .user-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .user-session-id {
      font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
      color: var(--primary-color);
      font-weight: 600;
      font-size: 13px;
    }

    .user-source {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 4px;
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    .user-source.memory {
      background: rgba(255, 165, 0, 0.2);
      color: #ffa500;
    }

    .user-source.supabase {
      background: rgba(245, 222, 64, 0.2);
      color: var(--primary-color);
    }

    .user-stats {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      font-size: 12px;
    }

    .user-stat {
      text-align: center;
    }

    .user-stat-value {
      color: var(--primary-color);
      font-weight: 600;
      font-size: 16px;
    }

    .user-stat-label {
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-size: 10px;
    }

    .user-last-activity {
      margin-top: 10px;
      font-size: 11px;
      color: var(--text-muted);
      text-align: center;
    }

    @media (max-width: 768px) {
      .settings-grid {
        grid-template-columns: 1fr;
      }

      .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }

      .admin-nav {
        flex-direction: column;
      }

      .table-nav {
        flex-direction: column;
      }

      .current-users-grid {
        grid-template-columns: 1fr;
      }

      .data-table {
        font-size: 11px;
      }

      .data-table th,
      .data-table td {
        padding: 8px 6px;
      }
    }

    /* Info Popup for Table Data */
    .info-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      backdrop-filter: blur(5px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 11000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s ease;
    }

    .info-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .info-popup {
      background: var(--surface-color);
      border: 1px solid var(--border-color);
      border-radius: 12px;
      padding: 30px;
      max-width: 80vw;
      max-height: 80vh;
      width: 600px;
      box-shadow: var(--shadow);
      transform: scale(0.9);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    .info-overlay.show .info-popup {
      transform: scale(1);
    }

    .info-title {
      color: var(--primary-color);
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--border-color);
    }

    .info-content {
      color: var(--text-color);
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap; /* Preserve whitespace and newlines */
      word-break: break-word; /* Break long words */
      overflow-y: auto; /* Add scroll for long content */
      flex-grow: 1;
      background: var(--background-color);
      padding: 15px;
      border-radius: 8px;
    }

    .info-close-btn {
      background: var(--surface-hover);
      border: 2px solid var(--border-color);
      border-radius: 8px;
      padding: 12px 24px;
      color: var(--text-color);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      margin-top: 20px;
      align-self: flex-end;
    }

    .info-close-btn:hover {
      background: var(--primary-color);
      color: #000;
      border-color: var(--primary-color);
    }

    .info-close-x {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .info-close-x:hover {
      background: var(--surface-hover);
      color: var(--text-color);
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="admin-login" id="loginScreen">
    <div class="login-box">
      <h1 style="color: var(--primary-color); margin-bottom: 20px;">Admin Panel</h1>
      <div id="authLoading" style="color: var(--text-muted); margin-bottom: 30px; font-style: italic;">
        Checking authentication status...
      </div>
      <div id="authLoginRequired" style="display: none;">
        <p style="color: var(--text-muted); margin-bottom: 30px;">Admin access required. Please login with an authorized Discord account.</p>
        <button class="discord-login-btn" onclick="loginWithDiscord()" style="width: 100%; justify-content: center;">
          <svg width="18" height="18" viewBox="0 0 71 55" fill="none">
            <g clip-path="url(#clip0)">
              <path d="M60.1045 4.8978C55.5792 2.8214 50.7265 1.2916 45.6527 0.41542C45.5603 0.39851 45.468 0.440769 45.4204 0.525289C44.7963 1.6353 44.105 3.0834 43.6209 4.2216C38.1637 3.4046 32.7345 3.4046 27.3892 4.2216C26.905 3.0581 26.1886 1.6353 25.5617 0.525289C25.5141 0.443589 25.4218 0.40133 25.3294 0.41542C20.2584 1.2888 15.4057 2.8186 10.8776 4.8978C10.8384 4.9147 10.8048 4.9429 10.7825 4.9795C1.57795 18.7309 -0.943561 32.1443 0.293408 45.3914C0.299005 45.4562 0.335386 45.5182 0.385761 45.5576C6.45866 50.0174 12.3413 52.7249 18.1147 54.5195C18.2071 54.5477 18.305 54.5139 18.3638 54.4378C19.7295 52.5728 20.9469 50.6063 21.9907 48.5383C22.0523 48.4172 21.9935 48.2735 21.8676 48.2256C19.9366 47.4931 18.0979 46.6 16.3292 45.5858C16.1893 45.5041 16.1781 45.304 16.3068 45.2082C16.679 44.9293 17.0513 44.6391 17.4067 44.3461C17.471 44.2926 17.5606 44.2813 17.6362 44.3151C29.2558 49.6202 41.8354 49.6202 53.3179 44.3151C53.3935 44.2785 53.4831 44.2898 53.5502 44.3433C53.9057 44.6363 54.2779 44.9293 54.6529 45.2082C54.7816 45.304 54.7732 45.5041 54.6333 45.5858C52.8646 46.6197 51.0259 47.4931 49.0921 48.2228C48.9662 48.2707 48.9102 48.4172 48.9718 48.5383C50.038 50.6034 51.2554 52.5699 52.5959 54.435C52.6519 54.5139 52.7526 54.5477 52.845 54.5195C58.6464 52.7249 64.529 50.0174 70.6019 45.5576C70.6551 45.5182 70.6887 45.459 70.6943 45.3942C72.1747 30.0791 68.2147 16.7757 60.1968 4.9823C60.1772 4.9429 60.1437 4.9147 60.1045 4.8978ZM23.7259 37.3253C20.2276 37.3253 17.3451 34.1136 17.3451 30.1693C17.3451 26.225 20.1717 23.0133 23.7259 23.0133C27.308 23.0133 30.1626 26.2532 30.1066 30.1693C30.1066 34.1136 27.308 37.3253 23.7259 37.3253ZM47.3178 37.3253C43.8196 37.3253 40.9371 34.1136 40.9371 30.1693C40.9371 26.225 43.7636 23.0133 47.3178 23.0133C50.9 23.0133 53.7545 26.2532 53.6986 30.1693C53.6986 34.1136 50.9 37.3253 47.3178 37.3253Z" fill="#5865F2"/>
            </g>
          </svg>
          Login with Discord
        </button>
      </div>
      <div id="authNoAccess" style="display: none;">
        <p style="color: #ff6b6b; margin-bottom: 20px;">❌ Access Denied</p>
        <p style="color: var(--text-muted); margin-bottom: 30px;">Your Discord account does not have admin access. Contact the administrator to request access.</p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button class="nav-btn" onclick="goToMainSite()" style="margin: 0;">← Back to Main Site</button>
          <button class="logout-btn" onclick="logout()" style="margin: 0;">Try Different Account</button>
        </div>
      </div>
      <div id="loginError" style="color: #ff6b6b; margin-top: 15px; display: none;"></div>
    </div>
  </div>

  <!-- Admin Panel -->
  <div class="admin-container" id="adminPanel">
    <button class="logout-btn" onclick="logout()">Logout</button>

    <div class="admin-header">
      <img src="https://cdn.discordapp.com/attachments/1368223638112698474/1409661544534642719/IMG_1145.png?ex=68ae311e&is=68acdf9e&hm=3368afde2d7bfb050dbe9375189692741011c098e1556a069f778648b70c0267" alt="Logo" class="header-logo" style="width: 150px; height: auto; margin-bottom: 5px;">
      <h1>ATC24 Control Panel</h1>
    </div>

    <div class="admin-nav">
      <button class="nav-btn active" onclick="showSection('analytics')">Analytics</button>
      <button class="nav-btn" onclick="showSection('tables')">Tables</button>
      <button class="nav-btn" onclick="showSection('settings')">Settings</button>
      <button class="nav-btn" onclick="showSection('users')">User Management</button>
      <button class="nav-btn" onclick="showSection('system')">System</button>
    </div>

    <!-- Analytics Section -->
    <div class="admin-section active" id="analytics">
      <div class="section">
        <h2 class="section-title">Real-Time Analytics</h2>

        <div class="analytics-grid">
          <div class="analytics-card">
            <div class="analytics-value" id="totalVisits">-</div>
            <div class="analytics-label">Total Visits</div>
          </div>

          <div class="analytics-card">
            <div class="analytics-value" id="todayVisits">-</div>
            <div class="analytics-label">Today's Visits</div>
          </div>

          <div class="analytics-card">
            <div class="analytics-value" id="last7Days">-</div>
            <div class="analytics-label">Last 7 Days</div>
          </div>

          <div class="analytics-card">
            <div class="analytics-value" id="clearancesGenerated">-</div>
            <div class="analytics-label">Clearances Generated</div>
          </div>

          <div class="analytics-card">
            <div class="analytics-value" id="flightPlansReceived">-</div>
            <div class="analytics-label">Flight Plans Received</div>
          </div>

          <div class="analytics-card">
            <div class="analytics-value" id="last30Days">-</div>
            <div class="analytics-label">Last 30 Days</div>
          </div>
        </div>

        <div class="chart-container">
          <div class="chart-header">
            <h3>Daily Visit Chart</h3>
            <p class="chart-subtitle">Website visits over the last 30 days</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="dailyVisitChart"></canvas>
            <div id="chartLoading" class="chart-loading">Loading chart data...</div>
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-header">
            <h3>Clearances per Day</h3>
            <p class="chart-subtitle">IFR clearances generated over the last 30 days</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="clearancesChart"></canvas>
            <div id="clearancesChartLoading" class="chart-loading">Loading chart data...</div>
          </div>
        </div>
        <div class="chart-container">
          <div class="chart-header">
            <h3>HTTP Requests per Day</h3>
            <p class="chart-subtitle">Page visits over the last 30 days</p>
          </div>
          <div class="chart-wrapper">
            <canvas id="requestsChart"></canvas>
            <div id="requestsChartLoading" class="chart-loading">Loading chart data...</div>
          </div>
        </div>

        <div class="danger-zone">
          <h3>Analytics Management</h3>
          <p style="color: var(--text-muted); margin-bottom: 15px;">Reset all analytics data (cannot be undone)</p>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button class="danger-btn" onclick="resetAnalytics()">Reset All Analytics</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Tables Section -->
    <div class="admin-section" id="tables">
      <div class="section">
        <h2 class="section-title">Supabase Database Tables</h2>

        <!-- Current Users -->
        <div class="current-users-section" style="margin-bottom: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="color: var(--primary-color); margin: 0;">Current Active Users</h3>
            <button class="nav-btn" onclick="loadCurrentUsers()" style="margin: 0; padding: 8px 16px;">Refresh Users</button>
          </div>

          <div class="analytics-grid" style="margin-bottom: 20px;">
            <div class="analytics-card">
              <div class="analytics-value" id="activeUsersCount">-</div>
              <div class="analytics-label">Active Users (5min)</div>
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="memorySessionsCount">-</div>
              <div class="analytics-label">Memory Sessions</div>
            </div>
            <div class="analytics-card">
              <div class="analytics-value" id="supabaseSessionsCount">-</div>
              <div class="analytics-label">Database Sessions</div>
            </div>
          </div>

          <div class="table-container" id="currentUsersTable">
            <div class="table-loading">Loading current users...</div>
          </div>
        </div>

        <!-- Table Navigation -->
        <div class="table-nav" style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
          <button class="table-nav-btn active" onclick="loadTable('page_visits')">Page Visits</button>
          <button class="table-nav-btn" onclick="loadTable('clearance_generations')">Clearances</button>
          <button class="table-nav-btn" onclick="loadTable('flight_plans_received')">Flight Plans</button>
          <button class="table-nav-btn" onclick="loadTable('user_sessions')">User Sessions</button>
          <button class="table-nav-btn" onclick="loadTable('discord_users')">Discord Users</button>
          <button class="table-nav-btn" onclick="loadTable('admin_activities')">Admin Activities</button>
        </div>

        <!-- Table Display Area -->
        <div class="table-info" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h3 id="currentTableTitle" style="color: var(--primary-color); margin: 0;">Page Visits</h3>
          <div style="display: flex; gap: 10px; align-items: center;">
            <span id="tableRecordCount" style="font-size: 12px; color: var(--text-muted);">Loading...</span>
            <button class="nav-btn" onclick="refreshCurrentTable()" style="margin: 0; padding: 6px 12px; font-size: 12px;">Refresh</button>
          </div>
        </div>

        <div class="table-container" id="tableDisplay">
          <div class="table-loading">Select a table to view data...</div>
        </div>

        <!-- Table Pagination -->
        <div class="table-pagination" id="tablePagination" style="display: none; margin-top: 15px; text-align: center;">
          <button class="nav-btn" onclick="previousPage()" id="prevBtn" style="margin: 0 5px; padding: 8px 16px;" disabled>Previous</button>
          <span id="pageInfo" style="margin: 0 15px; color: var(--text-muted);">Page 1</span>
          <button class="nav-btn" onclick="nextPage()" id="nextBtn" style="margin: 0 5px; padding: 8px 16px;" disabled>Next</button>
        </div>
      </div>
    </div>

    <!-- Settings Section -->
    <div class="admin-section" id="settings">
      <div class="section">
        <h2 class="section-title">System Configuration</h2>

        <div class="settings-grid">
          <div class="settings-group">
            <h3>Clearance Format & Phraseology</h3>

            <div class="setting-item">
              <label class="config-label">Phraseology Standard</label>
              <select id="phraseologyStyle" onchange="updatePhraseologyTemplate()">
                <option value="ICAO">ICAO Standard</option>
                <option value="FAA">FAA Standard</option>
                <option value="Local">Local Adaptation</option>
              </select>
            </div>

            <div class="setting-item">
              <label class="config-label">Custom Phraseology Format</label>
              <textarea id="phraseologyTemplate" placeholder="Enter custom clearance format template...">{CALLSIGN}, {ATC_STATION}, good day. Startup approved. Information {ATIS} is correct. Cleared to {DESTINATION} via {ROUTE}, runway {RUNWAY}. Initial climb {INITIAL_ALT}FT, expect further climb to Flight Level {FLIGHT_LEVEL}. Squawk {SQUAWK}.</textarea>
              <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
                Available variables: {CALLSIGN}, {ATC_STATION}, {ATIS}, {DESTINATION}, {ROUTE}, {RUNWAY}, {INITIAL_ALT}, {FLIGHT_LEVEL}, {SQUAWK}
              </div>
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="includeAtis">
              <label for="includeAtis">Include ATIS Information</label>
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="includeSquawk">
              <label for="includeSquawk">Include Squawk Code</label>
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="includeFlightLevel">
              <label for="includeFlightLevel">Include Expected Flight Level</label>
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="includeStartupApproval">
              <label for="includeStartupApproval">Include Startup Approval</label>
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="includeInitialClimb">
              <label for="includeInitialClimb">Include Initial Climb Instruction</label>
            </div>
          </div>

          <div class="settings-group">
            <h3>Aviation Standards</h3>

            <div class="setting-item">
              <label class="config-label">Default Altitudes (comma-separated)</label>
              <input type="text" id="defaultAltitudes" placeholder="1000,2000,3000,4000,5000">
            </div>

            <div class="setting-item">
              <label class="config-label">Squawk Code Range (Min)</label>
              <input type="number" id="squawkMin" placeholder="1000" min="1000" max="7777">
            </div>

            <div class="setting-item">
              <label class="config-label">Squawk Code Range (Max)</label>
              <input type="number" id="squawkMax" placeholder="7777" min="1000" max="7777">
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="enableRunwayValidation">
              <label for="enableRunwayValidation">Enable Runway Format Validation</label>
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="enableSIDValidation">
              <label for="enableSIDValidation">Enable SID/STAR Validation</label>
            </div>
          </div>

          <div class="settings-group">
            <h3>System Performance</h3>

            <div class="setting-item">
              <label class="config-label">Max Flight Plans Stored</label>
              <input type="number" id="maxFlightPlansStored" placeholder="20" min="5" max="100">
            </div>

            <div class="setting-item">
              <label class="config-label">Auto Refresh Interval (ms)</label>
              <input type="number" id="autoRefreshInterval" placeholder="30000" min="5000" max="300000" step="1000">
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="enableDetailedLogging">
              <label for="enableDetailedLogging">Enable Detailed Console Logging</label>
            </div>

            <div class="checkbox-item">
              <input type="checkbox" id="enableFlightPlanFiltering">
              <label for="enableFlightPlanFiltering">Enable Flight Plan Filtering</label>
            </div>
          </div>
        </div>

        <button class="generate-btn save-settings-btn" onclick="saveSettings()">Save All Settings</button>
      </div>
    </div>

    <!-- System Section -->
    <div class="admin-section" id="system">
      <div class="section">
        <h2 class="section-title">System Information</h2>

        <div class="settings-grid">
          <div class="settings-group">
            <h3>WebSocket Status</h3>
            <div id="wsStatus" style="padding: 20px; text-align: center; border-radius: 8px; margin-bottom: 20px; background: var(--surface-hover); border: 1px solid var(--border-color);">
              <div style="color: var(--text-muted); font-weight: 600;">Initializing system status...</div>
            </div>
          </div>

          <div class="settings-group">
            <h3>System Health</h3>
            <div style="padding: 20px;">
              <div style="margin-bottom: 15px;">
                <strong>Environment:</strong> <span id="environmentInfo">-</span>
              </div>
              <div style="margin-bottom: 15px;">
                <strong>Flight Plans in Memory:</strong> <span id="systemFlightPlans">-</span>
              </div>
              <div style="margin-bottom: 15px;">
                <strong>Real-time Support:</strong> <span id="realtimeSupport">-</span>
              </div>
              <div style="margin-bottom: 15px;">
                <strong>Last Analytics Reset:</strong> <span id="lastReset">-</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Debug Logs Section -->
        <div class="settings-group" style="margin-top: 30px;">
          <h3>Runtime Debug Logs</h3>
          <div style="margin-bottom: 15px;">
            <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
              <select id="logLevel" style="padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--surface-hover); color: var(--text-color);">
                <option value="all">All Levels</option>
                <option value="error">Errors Only</option>
                <option value="warn">Warnings Only</option>
                <option value="info">Info Only</option>
              </select>
              <button class="nav-btn" style="padding: 8px 16px; margin: 0;" onclick="loadDebugLogs()">Refresh Logs</button>
              <button class="nav-btn" style="padding: 8px 16px; margin: 0;" onclick="clearLogDisplay()">Clear Display</button>
            </div>
          </div>
          <div id="debugLogs" style="
            background: #1a1a1a;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            height: 400px;
            overflow-y: auto;
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', monospace;
            font-size: 12px;
            line-height: 1.4;
            color: #e0e0e0;
          ">
            <div style="color: var(--text-muted);">Loading debug logs...</div>
          </div>
        </div>

      </div>
    </div>

    <!-- User Management Section -->
    <div class="admin-section" id="users">
      <div class="section">
        <h2 class="section-title">User Management</h2>

        <!-- Current Admin Info -->
        <div class="settings-group" style="margin-bottom: 30px;">
          <h3>Current Admin User</h3>
          <div id="currentAdminInfo" style="padding: 20px; background: var(--surface-hover); border: 1px solid var(--border-color); border-radius: 8px;">
            <div style="color: var(--text-muted);">Loading current user info...</div>
          </div>
        </div>

        <!-- Admin Users List -->
        <div class="settings-group" style="margin-bottom: 30px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3>Admin Users</h3>
            <button class="nav-btn" onclick="loadAdminUsers()" style="margin: 0; padding: 8px 16px;">Refresh Users</button>
          </div>

          <div id="adminUsersList" style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; min-height: 200px;">
            <div style="padding: 20px; text-align: center; color: var(--text-muted);">Loading admin users...</div>
          </div>
        </div>

        <!-- Add New Admin -->
        <div class="settings-group">
          <h3>Add New Admin User</h3>
          <div style="padding: 20px; background: var(--surface-hover); border: 1px solid var(--border-color); border-radius: 8px;">
            <div style="margin-bottom: 20px;">
              <label class="config-label" style="display: block; margin-bottom: 8px;">Discord Username</label>
              <input type="text" id="newAdminUsername" placeholder="e.g., h.a.s2 or user#1234" style="width: 100%; margin-bottom: 10px;">
              <div style="font-size: 12px; color: var(--text-muted); margin-bottom: 15px;">
                Enter the Discord username exactly as it appears (with or without discriminator)
              </div>
            </div>

            <div style="margin-bottom: 20px;">
              <label class="config-label" style="display: block; margin-bottom: 8px;">Admin Roles</label>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="roleAdmin" checked>
                  <span>Admin</span>
                </label>
                <label style="display: flex; align-items: center; gap: 8px;">
                  <input type="checkbox" id="roleSuperAdmin">
                  <span>Super Admin</span>
                </label>
              </div>
            </div>

            <div style="display: flex; gap: 10px;">
              <button class="generate-btn" onclick="addAdminUser()" style="flex: 1; margin: 0;">Add Admin User</button>
              <button class="nav-btn" onclick="clearAddUserForm()" style="margin: 0; padding: 12px 20px;">Clear</button>
            </div>
          </div>
        </div>

        <!-- Danger Zone -->
        <div class="danger-zone" style="margin-top: 30px;">
          <h3>Danger Zone</h3>
          <p style="color: var(--text-muted); margin-bottom: 15px;">Removing admin users cannot be undone. Use with caution.</p>
          <div style="display: flex; gap: 15px; flex-wrap: wrap;">
            <button class="danger-btn" onclick="showRemoveAdminDialog()">Remove Admin User</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Popup -->
  <div class="notification-overlay" id="notificationOverlay">
    <div class="notification-popup" id="notificationPopup">
      <button class="notification-close-x" onclick="hideNotification()">×</button>
      <div class="notification-icon" id="notificationIcon">✓</div>
      <div class="notification-title" id="notificationTitle">Operation Successful</div>
      <div class="notification-message" id="notificationMessage">Your request has been completed successfully.</div>
      <button class="notification-close-btn" onclick="hideNotification()">Close</button>
    </div>
  </div>

  <!-- Info Popup for Table Data -->
  <div class="info-overlay" id="infoOverlay">
    <div class="info-popup" id="infoPopup">
      <button class="info-close-x" onclick="hideInfoPopup()">×</button>
      <h3 class="info-title" id="infoTitle">Full Cell Content</h3>
      <div class="info-content" id="infoContent">
        <!-- Full content will be injected here -->
      </div>
      <button class="info-close-btn" onclick="hideInfoPopup()">Close</button>
    </div>
  </div>

  <script>
    // Info Popup for Table Data
    function showInfoPopup(content) {
      const overlay = document.getElementById('infoOverlay');
      const contentEl = document.getElementById('infoContent');

      contentEl.textContent = content; // Use textContent for security
      overlay.classList.add('show');
    }

    function hideInfoPopup() {
      const overlay = document.getElementById('infoOverlay');
      overlay.classList.remove('show');
    }

    let currentUser = null;
    let sessionId = null;
    let analytics = {};
    let settings = {};
    let dailyVisitChart = null;
    // let currentPassword = localStorage.getItem('admin_password'); // DEPRECATED for security

    // Notification System
    function showNotification(type, title, message) {
      const overlay = document.getElementById('notificationOverlay');
      const popup = document.getElementById('notificationPopup');
      const icon = document.getElementById('notificationIcon');
      const titleEl = document.getElementById('notificationTitle');
      const messageEl = document.getElementById('notificationMessage');

      // Set content
      titleEl.textContent = title;
      messageEl.textContent = message;

      // Set icon and styling based on type
      popup.className = 'notification-popup ' + type;
      icon.className = 'notification-icon ' + type;

      switch(type) {
        case 'success':
          icon.textContent = '✓';
          break;
        case 'error':
          icon.textContent = '✕';
          break;
        case 'warning':
          icon.textContent = '⚠';
          break;
        case 'info':
          icon.textContent = 'i';
          break;
      }

      // Show notification
      overlay.classList.add('show');

      // Auto-hide after 4 seconds for success notifications
      if (type === 'success') {
        setTimeout(() => {
          hideNotification();
        }, 4000);
      }
    }

    function hideNotification() {
      const overlay = document.getElementById('notificationOverlay');
      overlay.classList.remove('show');
    }

    // Close notification when clicking overlay
    document.getElementById('notificationOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        hideNotification();
      }
    });

    // Add event listener to close info popup on overlay click
    document.getElementById('infoOverlay').addEventListener('click', function(e) {
      if (e.target === this) {
        hideInfoPopup();
      }
    });

    // Authentication Functions
    async function checkAuthStatus() {
      const currentSessionId = getSessionId();
      if (!currentSessionId) {
        console.log('No session ID found. Showing login required.');
        showLoginRequired();
        return;
      }

      try {
        document.getElementById('authLoading').style.display = 'block';
        document.getElementById('authLoginRequired').style.display = 'none';
        document.getElementById('authNoAccess').style.display = 'none';

        const response = await fetch('/api/auth/user', {
          headers: {
            'X-Session-ID': currentSessionId
          }
        });

        if (response.ok) {
          const authData = await response.json();
          if (authData.authenticated && authData.user.is_admin) {
            currentUser = authData.user;
            sessionId = currentSessionId;
            showAdminPanel();
          } else if (authData.authenticated && !authData.user.is_admin) {
            showNoAccess();
          } else {
            // Session ID was invalid or expired
            localStorage.removeItem('atc24_session_id');
            showLoginRequired();
          }
        } else {
          // Handle server errors (e.g., 500)
          showAuthError('Server error during authentication check.');
          showLoginRequired();
        }
      } catch (error) {
        console.error('Auth check failed:', error);
        showAuthError('Network error: Failed to check authentication status.');
        showLoginRequired(); // Show login as a fallback
      }
    }

    function showAdminPanel() {
      document.getElementById('loginScreen').classList.add('fade-out');
      document.getElementById('adminPanel').classList.add('authenticated');
      showNotification('success', 'Access Granted', `Welcome ${currentUser.username}! Admin access confirmed.`);
      loadAdminData();
    }

    function showLoginRequired() {
      document.getElementById('authLoading').style.display = 'none';
      document.getElementById('authLoginRequired').style.display = 'block';
      document.getElementById('authNoAccess').style.display = 'none';
    }

    function showNoAccess() {
      document.getElementById('authLoading').style.display = 'none';
      document.getElementById('authLoginRequired').style.display = 'none';
      document.getElementById('authNoAccess').style.display = 'block';
    }

    function loginWithDiscord() {
      window.location.href = '/auth/discord';
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionId
          }
        });
      } catch (error) {
        console.error('Logout failed:', error);
      }

      currentUser = null;
      sessionId = null;
      localStorage.removeItem('atc24_session_id'); // Clear local session ID on logout
      localStorage.removeItem('admin_password'); // Clear stored password on logout
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('adminPanel').classList.remove('authenticated');
      showLoginRequired();
    }

    function goToMainSite() {
      window.location.href = '/';
    }

    function getSessionId() {
      // Try to get session ID from URL parameters first
      const urlParams = new URLSearchParams(window.location.search);
      const urlSessionId = urlParams.get('session');
      if (urlSessionId) {
        localStorage.setItem('atc24_session_id', urlSessionId);
        // Clean up URL
        const newUrl = window.location.pathname + (window.location.search.replace(/&?session=[^&]*/, '').replace(/^\?$/, ''));
        window.history.replaceState({}, document.title, newUrl);
        return urlSessionId;
      }

      // Try to get from cookie
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        const [name, value] = cookie.trim().split('=');
        if (name === 'session_id' && value) {
          localStorage.setItem('atc24_session_id', value);
          return value;
        }
      }

      // Fallback to localStorage, return null if not found
      return localStorage.getItem('atc24_session_id');
    }

    function showAuthError(message) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = message;
      errorDiv.style.display = 'block';
      setTimeout(() => {
        errorDiv.style.display = 'none';
      }, 5000);
    }

    // Check for auth success/error in URL params
    function checkAuthParams() {
      const urlParams = new URLSearchParams(window.location.search);
      const authResult = urlParams.get('auth');
      const authError = urlParams.get('error');

      if (authResult === 'success') {
        console.log('Discord authentication successful');
        window.history.replaceState({}, document.title, window.location.pathname);
        setTimeout(checkAuthStatus, 500);
      } else if (authError) {
        console.error('Discord authentication error:', authError);
        showAuthError(`Authentication failed: ${authError}`);
        window.history.replaceState({}, document.title, window.location.pathname);
      }
    }

    // Navigation
    function showSection(sectionName) {
      // Hide all sections
      document.querySelectorAll('.admin-section').forEach(section => {
        section.classList.remove('active');
      });

      // Remove active class from all nav buttons
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected section
      document.getElementById(sectionName).classList.add('active');

      // Add active class to clicked button
      event.target.classList.add('active');

      // Load section-specific data
      if (sectionName === 'analytics') {
        loadAnalytics();
      } else if (sectionName === 'tables') {
        loadCurrentUsers();
        loadTable('page_visits');
      } else if (sectionName === 'users') {
        loadCurrentAdminInfo();
        loadAdminUsers();
      } else if (sectionName === 'system') {
        loadSystemInfo();
        loadDebugLogs();
      }
    }

    // Data loading
    async function loadAdminData() {
      await Promise.all([
        loadAnalytics(),
        loadSettings(),
        loadSystemInfo()
      ]);
      // Load debug logs after other data is loaded
      loadDebugLogs();
    }

    async function loadAnalytics() {
      try {
        const response = await fetch('/api/admin/analytics', {
          headers: {
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });
        analytics = await response.json();

        const today = new Date().toISOString().split('T')[0];

        document.getElementById('totalVisits').textContent = analytics.totalVisits || 0;
        document.getElementById('todayVisits').textContent = analytics.dailyVisits?.[today] || 0;
        document.getElementById('last7Days').textContent = analytics.last7Days || 0;
        document.getElementById('last30Days').textContent = analytics.last30Days || 0;
        document.getElementById('clearancesGenerated').textContent = analytics.clearancesGenerated || 0;
        document.getElementById('flightPlansReceived').textContent = analytics.flightPlansReceived || 0;

        // Load chart data
        loadChartData();
      } catch (error) {
        console.error('Failed to load analytics:', error);
        showNotification('warning', 'Data Load Warning', 'Some analytics data may not be current. Refreshing automatically...');
      }
    }

    let charts = {};
    async function loadChartData() {
        try {
            const response = await fetch('/api/admin/charts', {
                headers: {
                    'X-Session-ID': sessionId,
                    'Authorization': `Bearer ${sessionId}`
                }
            });
            const chartData = await response.json();

            // Hide loading indicators
            document.getElementById('chartLoading').style.display = 'none';
            document.getElementById('clearancesChartLoading').style.display = 'none';
            document.getElementById('requestsChartLoading').style.display = 'none';

            // Render charts
            renderLineChart('dailyVisitChart', chartData.daily_visits, 'Daily Visits', '#f5de40');
            renderLineChart('clearancesChart', chartData.daily_clearances, 'Clearances per Day', '#3498db');
            renderLineChart('requestsChart', chartData.daily_visits, 'HTTP Requests per Day', '#e74c3c');

        } catch (error) {
            console.error('Failed to load chart data:', error);
        }
    }

    function renderLineChart(canvasId, data, label, color) {
        const chartCanvas = document.getElementById(canvasId);
        if (!chartCanvas || !data) return;

        const last30Days = [];
        const counts = [];
        const dataMap = new Map(data.map(item => [item.date.split('T')[0], item.count]));

        for (let i = 29; i >= 0; i--) {
            const date = new Date();
            date.setDate(date.getDate() - i);
            const dateStr = date.toISOString().split('T')[0];
            const dayLabel = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            last30Days.push(dayLabel);
            counts.push(dataMap.get(dateStr) || 0);
        }

        if (charts[canvasId]) {
            charts[canvasId].destroy();
        }

        const ctx = chartCanvas.getContext('2d');
        charts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: last30Days,
                datasets: [{
                    label: label,
                    data: counts,
                    borderColor: color,
                    backgroundColor: `${color}1a`, // Hex with alpha
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointBackgroundColor: color,
                    pointBorderColor: '#000',
                    pointBorderWidth: 1,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleColor: color,
                        bodyColor: '#ffffff',
                        borderColor: color,
                        borderWidth: 1,
                        cornerRadius: 8,
                        displayColors: false
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#888', font: { size: 11 }, maxTicksLimit: 8 }
                    },
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: { color: '#888', font: { size: 11 }, precision: 0 }
                    }
                },
                interaction: { intersect: false, mode: 'index' }
            }
        });
    }

    async function loadSettings() {
      try {
        const response = await fetch(`/api/admin/settings`, {
          headers: {
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });
        settings = await response.json();

        // Clearance format settings
        document.getElementById('phraseologyStyle').value = settings.clearanceFormat?.phraseologyStyle || 'ICAO';
        document.getElementById('phraseologyTemplate').value = settings.clearanceFormat?.customTemplate || '{CALLSIGN}, {ATC_STATION}, good day. Startup approved. Information {ATIS} is correct. Cleared to {DESTINATION} via {ROUTE}, runway {RUNWAY}. Initial climb {INITIAL_ALT}FT, expect further climb to Flight Level {FLIGHT_LEVEL}. Squawk {SQUAWK}.';
        document.getElementById('includeAtis').checked = settings.clearanceFormat?.includeAtis !== false;
        document.getElementById('includeSquawk').checked = settings.clearanceFormat?.includeSquawk !== false;
        document.getElementById('includeFlightLevel').checked = settings.clearanceFormat?.includeFlightLevel !== false;
        document.getElementById('includeStartupApproval').checked = settings.clearanceFormat?.includeStartupApproval !== false;
        document.getElementById('includeInitialClimb').checked = settings.clearanceFormat?.includeInitialClimb !== false;

        // Aviation settings
        document.getElementById('defaultAltitudes').value = settings.aviation?.defaultAltitudes?.join(',') || '1000,2000,3000,4000,5000';
        document.getElementById('squawkMin').value = settings.aviation?.squawkRanges?.min || 1000;
        document.getElementById('squawkMax').value = settings.aviation?.squawkRanges?.max || 7777;
        document.getElementById('enableRunwayValidation').checked = settings.aviation?.enableRunwayValidation || false;
        document.getElementById('enableSIDValidation').checked = settings.aviation?.enableSIDValidation || false;

        // System settings
        document.getElementById('maxFlightPlansStored').value = settings.system?.maxFlightPlansStored || 20;
        document.getElementById('autoRefreshInterval').value = settings.system?.autoRefreshInterval || 30000;
        document.getElementById('enableDetailedLogging').checked = settings.system?.enableDetailedLogging || false;
        document.getElementById('enableFlightPlanFiltering').checked = settings.system?.enableFlightPlanFiltering || false;
      } catch (error) {
        console.error('Failed to load settings:', error);
      }
    }

    async function loadSystemInfo() {
      const wsStatus = document.getElementById('wsStatus');

      // Set loading state without ugly spinner
      wsStatus.innerHTML = '<div style="color: var(--text-muted); font-weight: 600;">Loading status...</div>';
      wsStatus.style.background = 'var(--surface-hover)';
      wsStatus.style.border = '1px solid var(--border-color)';

      try {
        const response = await fetch('/health');

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const health = await response.json();
        console.log('System health data:', health);

        // WebSocket status with environment awareness
        if (health.environment === 'serverless') {
          wsStatus.innerHTML = '<div style="width: 12px; height: 12px; background: #ffa500; border-radius: 50%; margin: 0 auto 10px;"></div><div style="color: #ffa500; font-weight: 600;">WebSocket Disabled</div><div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Serverless deployment - using polling fallback</div>';
          wsStatus.style.background = 'rgba(255, 165, 0, 0.1)';
          wsStatus.style.border = '1px solid rgba(255, 165, 0, 0.3)';
        } else if (health.wsStatus === 'connected') {
          wsStatus.innerHTML = '<div style="width: 12px; height: 12px; background: var(--primary-color); border-radius: 50%; margin: 0 auto 10px;"></div><div style="color: var(--primary-color); font-weight: 600;">WebSocket Connected</div><div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Real-time data active</div>';
          wsStatus.style.background = 'rgba(245, 222, 64, 0.1)';
          wsStatus.style.border = '1px solid rgba(245, 222, 64, 0.3)';
        } else if (health.wsStatus === 'disconnected' || health.wsStatus === 'not_initialized') {
          wsStatus.innerHTML = '<div style="width: 12px; height: 12px; background: #ff6b6b; border-radius: 50%; margin: 0 auto 10px;"></div><div style="color: #ff6b6b; font-weight: 600;">WebSocket Disconnected</div><div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">No real-time connection</div>';
          wsStatus.style.background = 'rgba(255, 107, 107, 0.1)';
          wsStatus.style.border = '1px solid rgba(255, 107, 107, 0.3)';
        } else {
          // Fallback for unknown status
          wsStatus.innerHTML = '<div style="width: 12px; height: 12px; background: var(--text-muted); border-radius: 50%; margin: 0 auto 10px;"></div><div style="color: var(--text-muted); font-weight: 600;">Status Unknown</div><div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Unable to determine connection status</div>';
          wsStatus.style.background = 'var(--surface-hover)';
          wsStatus.style.border = '1px solid var(--border-color)';
        }

        // System info
        document.getElementById('systemFlightPlans').textContent = health.flightPlansCount || 0;

        // Update environment info
        const environmentInfo = document.getElementById('environmentInfo');
        if (environmentInfo) {
          environmentInfo.textContent = health.environment === 'serverless' ? 'Serverless (Vercel)' : 'Traditional Server';
        }

        // Update realtime support info
        const realtimeSupport = document.getElementById('realtimeSupport');
        if (realtimeSupport) {
          if (health.supportsRealtime) {
            realtimeSupport.innerHTML = '<span style="color: var(--primary-color);">✓ WebSocket Available</span>';
          } else {
            realtimeSupport.innerHTML = '<span style="color: #ffa500;">⚠ Polling Fallback Only</span>';
          }
        }

        if (analytics.lastReset) {
          document.getElementById('lastReset').textContent = new Date(analytics.lastReset).toLocaleString();
        }
      } catch (error) {
        console.error('Failed to load system info:', error);
        // Show clear error state without ugly icons
        wsStatus.innerHTML = '<div style="color: #ff6b6b; font-weight: 600;">Connection Failed</div><div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">Unable to fetch system status</div>';
        wsStatus.style.background = 'rgba(255, 107, 107, 0.1)';
        wsStatus.style.border = '1px solid rgba(255, 107, 107, 0.3)';
      }
    }

    // Phraseology template management
    function updatePhraseologyTemplate() {
      const style = document.getElementById('phraseologyStyle').value;
      const templateField = document.getElementById('phraseologyTemplate');

      let template = '';
      switch(style) {
        case 'ICAO':
          template = '{CALLSIGN}, {ATC_STATION}, good day. Startup approved. Information {ATIS} is correct. Cleared to {DESTINATION} via {ROUTE}, runway {RUNWAY}. Initial climb {INITIAL_ALT}FT, expect further climb to Flight Level {FLIGHT_LEVEL}. Squawk {SQUAWK}.';
          break;
        case 'FAA':
          template = '{CALLSIGN}, {ATC_STATION}. Cleared to {DESTINATION} airport via {ROUTE}, runway {RUNWAY}. Climb and maintain {INITIAL_ALT}, expect {FLIGHT_LEVEL} 10 minutes after departure. Departure frequency will be as published. Squawk {SQUAWK}.';
          break;
        case 'Local':
          template = '{CALLSIGN}, {ATC_STATION}. You are cleared to {DESTINATION} via {ROUTE}, departing runway {RUNWAY}. Climb initially to {INITIAL_ALT} feet, expect flight level {FLIGHT_LEVEL}. Squawk {SQUAWK}. Contact ground for pushback.';
          break;
      }

      templateField.value = template;
    }

    // Settings management
    async function saveSettings() {
      try {
        const newSettings = {
          clearanceFormat: {
            phraseologyStyle: document.getElementById('phraseologyStyle').value,
            customTemplate: document.getElementById('phraseologyTemplate').value,
            includeAtis: document.getElementById('includeAtis').checked,
            includeSquawk: document.getElementById('includeSquawk').checked,
            includeFlightLevel: document.getElementById('includeFlightLevel').checked,
            includeStartupApproval: document.getElementById('includeStartupApproval').checked,
            includeInitialClimb: document.getElementById('includeInitialClimb').checked
          },
          aviation: {
            defaultAltitudes: document.getElementById('defaultAltitudes').value.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n)),
            squawkRanges: {
              min: parseInt(document.getElementById('squawkMin').value) || 1000,
              max: parseInt(document.getElementById('squawkMax').value) || 7777,
              exclude: [7500, 7600, 7700]
            },
            enableRunwayValidation: document.getElementById('enableRunwayValidation').checked,
            enableSIDValidation: document.getElementById('enableSIDValidation').checked
          },
          system: {
            maxFlightPlansStored: parseInt(document.getElementById('maxFlightPlansStored').value) || 20,
            autoRefreshInterval: parseInt(document.getElementById('autoRefreshInterval').value) || 30000,
            enableDetailedLogging: document.getElementById('enableDetailedLogging').checked,
            enableFlightPlanFiltering: document.getElementById('enableFlightPlanFiltering').checked
          }
        };

        const response = await fetch('/api/admin/settings', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          },
          body: JSON.stringify({ settings: newSettings })
        });

        const result = await response.json();
        if (result.success) {
          showNotification('success', 'Settings Saved', 'All configuration changes have been applied successfully');
          settings = result.settings;
        } else {
          showNotification('error', 'Save Failed', 'Unable to save settings. Please try again.');
        }
      } catch (error) {
        console.error('Failed to save settings:', error);
        showNotification('error', 'Connection Error', 'Failed to communicate with server. Check your connection.');
      }
    }

    // Test analytics function removed for security

    async function resetAnalytics() {
      if (!confirm('This will permanently delete all analytics data. Are you sure?')) {
        return;
      }

      try {
        const response = await fetch('/api/admin/reset-analytics', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });

        const result = await response.json();
        if (result.success) {
          showNotification('success', 'Analytics Reset', 'All analytics data has been cleared successfully');
          loadAnalytics();
        } else {
          showNotification('error', 'Reset Failed', 'Unable to reset analytics. Please try again.');
        }
      } catch (error) {
        console.error('Failed to reset analytics:', error);
        showNotification('error', 'Connection Error', 'Failed to communicate with server. Check your connection.');
      }
    }

    // Debug logs functionality
    async function loadDebugLogs() {
      // The backend now uses session authentication, so no password is needed.
      const levelSelect = document.getElementById('logLevel');
      const debugLogsContainer = document.getElementById('debugLogs');

      if (!levelSelect || !debugLogsContainer) {
        console.error('Debug logs UI elements not found');
        return;
      }

      const level = levelSelect.value || 'all';

      try {
        debugLogsContainer.innerHTML = '<div style="color: var(--text-muted);">Loading debug logs...</div>';

        const url = `/api/admin/logs?level=${encodeURIComponent(level)}&limit=50`;
        const response = await fetch(url, {
          headers: {
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Invalid response from server' }));
            throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorData.error || 'No error details'}`);
        }

        const data = await response.json();

        // Check for server-side error
        if (data.error) {
          throw new Error(`Server error: ${data.error}`);
        }


        // Display logs
        if (!data.logs || data.logs.length === 0) {
          debugLogsContainer.innerHTML = '<div style="color: var(--text-muted);">No logs found for selected filter.</div>';
          return;
        }

        const logsHtml = data.logs.map(log => {
          if (!log || !log.timestamp || !log.level || !log.message) {
            return '<div style="color: #ff6b6b;">Invalid log entry</div>';
          }

          const time = new Date(log.timestamp).toLocaleTimeString();
          const date = new Date(log.timestamp).toLocaleDateString();
          let levelColor = '#e0e0e0';

          switch(log.level) {
            case 'error': levelColor = '#ff6b6b'; break;
            case 'warn': levelColor = '#ffa500'; break;
            case 'info': levelColor = '#4CAF50'; break;
            default: levelColor = '#87CEEB'; break;
          }

          return `
            <div style="margin-bottom: 8px; padding: 6px 0; border-bottom: 1px solid #333;">
              <span style="color: #888; font-size: 11px;">[${date} ${time}]</span>
              <span style="color: ${levelColor}; font-weight: bold; margin-left: 8px;">${log.level.toUpperCase()}</span>
              <span style="color: #bbb; margin-left: 8px; font-size: 10px;">(${log.id || 'no-id'})</span>
              <div style="margin-top: 2px; color: #e0e0e0;">${escapeHtml(log.message)}</div>
              ${log.data ? `<div style="margin-top: 2px; color: #999; font-size: 11px; font-style: italic;">${escapeHtml(log.data)}</div>` : ''}
            </div>
          `;
        }).join('');

        debugLogsContainer.innerHTML = logsHtml;

        // Auto-scroll to top for newest logs
        debugLogsContainer.scrollTop = 0;

      } catch (error) {
        console.error('Failed to load debug logs:', error);
        debugLogsContainer.innerHTML = `
          <div style="color: #ff6b6b; margin-bottom: 10px;">Failed to load debug logs</div>
          <div style="color: #ffa500; font-size: 12px; margin-bottom: 5px;">Error Details</div>
          <div style="color: #999; font-size: 11px; margin-bottom: 10px;">${escapeHtml(error.message)}</div>
          <div style="color: #666; font-size: 10px;">
            <div>• Check console (F12) for technical details</div>
            <div>• Verify admin session is active</div>
          </div>
        `;
      }
    }

    function clearLogDisplay() {
      document.getElementById('debugLogs').innerHTML = '<div style="color: var(--text-muted);">Log display cleared. Click "Refresh Logs" to reload.</div>';
    }

    async function testDebugLogsEndpoint() {
      const debugLogsContainer = document.getElementById('debugLogs');

      if (!debugLogsContainer) {
        console.error('Debug logs container not found');
        return;
      }

      debugLogsContainer.innerHTML = '<div style="color: var(--primary-color);">Testing debug logs endpoint...</div>';

      try {
        // Test basic connectivity first
        console.log('Testing basic endpoint connectivity...');

        const testUrl = `/api/admin/logs?level=all&limit=5`;
        console.log('Test URL:', testUrl);

        const response = await fetch(testUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json',
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });

        console.log('Test response received:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok
        });

        const responseText = await response.text();
        console.log('Raw response text:', responseText);

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}\nResponse: ${responseText}`);
        }

        let data;
        try {
          data = JSON.parse(responseText);
        } catch (parseError) {
          throw new Error(`JSON Parse Error: ${parseError.message}\nResponse: ${responseText}`);
        }

        console.log('Parsed response data:', data);

        // Display test results
        debugLogsContainer.innerHTML = `
          <div style="color: #4CAF50; margin-bottom: 10px;">✓ Endpoint Test Successful</div>
          <div style="color: #e0e0e0; font-size: 12px;">
            <div>Status: ${response.status} ${response.statusText}</div>
            <div>Logs Available: ${data.totalCount || 0}</div>
            <div>Response Valid: ${data.logs ? 'Yes' : 'No'}</div>
            <div>Server Time: ${data.serverStartTime || 'Unknown'}</div>
          </div>
          <div style="color: var(--text-muted); font-size: 11px; margin-top: 10px;">
            Test completed successfully. Click "Refresh Logs" to load full data.
          </div>
        `;

      } catch (error) {
        console.error('Endpoint test failed:', error);

        debugLogsContainer.innerHTML = `
          <div style="color: #ff6b6b; margin-bottom: 10px;">✗ Endpoint Test Failed</div>
          <div style="color: #999; font-size: 11px; margin-bottom: 10px;">
            Error: ${escapeHtml(error.message)}
          </div>
          <div style="color: #666; font-size: 10px;">
            See console for full technical details
          </div>
        `;
      }
    }

    function escapeHtml(text) {
      if (typeof text !== 'string') {
        return String(text || '');
      }
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Tables functionality
    let currentTable = 'page_visits';
    let currentOffset = 0;
    const pageSize = 25;
    let totalRecords = 0;

    async function loadTable(tableName) {
      try {
        currentTable = tableName;
        currentOffset = 0;

        // Update active nav button
        document.querySelectorAll('.table-nav-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');

        // Update table title
        const titles = {
          'page_visits': 'Page Visits',
          'clearance_generations': 'Clearance Generations',
          'flight_plans_received': 'Flight Plans Received',
          'user_sessions': 'User Sessions',
          'admin_activities': 'Admin Activities'
        };
        document.getElementById('currentTableTitle').textContent = titles[tableName] || tableName;

        await fetchTableData();
      } catch (error) {
        console.error('Error loading table:', error);
        showNotification('error', 'Load Error', 'Failed to load table data');
      }
    }

    async function fetchTableData() {
      const tableDisplay = document.getElementById('tableDisplay');
      try {
        tableDisplay.innerHTML = '<div class="table-loading">Loading table data...</div>';

        // Removed insecure password from URL. Session auth is handled by the browser cookie.
        const url = `/api/admin/tables/${currentTable}?limit=${pageSize}&offset=${currentOffset}`;
        const response = await fetch(url, {
          headers: {
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });

        if (!response.ok) {
            const errorData = await response.json().catch(() => ({ error: 'Invalid response from server' }));
            throw new Error(`HTTP ${response.status}: ${response.statusText} - ${errorData.error || 'No error details'}`);
        }

        const data = await response.json();
        totalRecords = data.totalCount || 0;

        // Handle cases where setup is required
        if (data.setupRequired) {
          tableDisplay.innerHTML = `
            <div style="padding: 40px; text-align: center; color: var(--text-muted);">
              <div style="font-size: 18px; color: var(--primary-color); margin-bottom: 15px;">⚠️ Database Setup Required</div>
              <div style="margin-bottom: 20px;">${data.message || 'The required table does not exist.'}</div>
              <div style="background: var(--surface-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 20px; margin: 20px auto; max-width: 600px; text-align: left;">
                <div style="font-weight: 600; margin-bottom: 10px; color: var(--primary-color);">Next Steps:</div>
                <div style="font-size: 13px; line-height: 1.6;">
                  1. Go to your <a href="https://supabase.com/dashboard" target="_blank" style="color: var(--primary-color);">Supabase Dashboard</a> and select this project.<br>
                  2. Navigate to the <strong>SQL Editor</strong>.<br>
                  3. Run the provided SQL migration script to create all necessary tables and functions.<br>
                  4. After the script runs successfully, refresh this page.
                </div>
              </div>
              <button class="nav-btn" onclick="refreshCurrentTable()" style="margin: 10px;">Retry after Setup</button>
            </div>
          `;
          document.getElementById('tableRecordCount').textContent = 'Setup required';
          document.getElementById('tablePagination').style.display = 'none';
          return;
        }

        if (!data.data || data.data.length === 0) {
          tableDisplay.innerHTML = '<div class="table-loading">No records found in this table.</div>';
          document.getElementById('tableRecordCount').textContent = '0 records';
          document.getElementById('tablePagination').style.display = 'none';
          return;
        }

        // Update record count
        const startRecord = currentOffset + 1;
        const endRecord = Math.min(currentOffset + pageSize, totalRecords);
        document.getElementById('tableRecordCount').textContent = `Showing ${startRecord}-${endRecord} of ${totalRecords} records`;

        // Generate table HTML
        const tableHtml = generateTableHtml(data.data);
        tableDisplay.innerHTML = tableHtml;

        // Update pagination
        updatePagination();

      } catch (error) {
        console.error('Error fetching table data:', error);
        tableDisplay.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #ff6b6b;">
            <div style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">❌ Failed to Load Table Data</div>
            <div style="font-family: 'SF Mono', 'Monaco', monospace; font-size: 13px; color: #ffa500; margin-bottom: 20px;">${escapeHtml(error.message)}</div>
            <div style="color: var(--text-muted); font-size: 13px;">This could be due to a database connection issue, a problem with the server, or incorrect RLS policies. Check the server logs for more details.</div>
            <button class="nav-btn" onclick="refreshCurrentTable()" style="margin-top: 20px;">Try Again</button>
          </div>
        `;
        document.getElementById('tableRecordCount').textContent = 'Error';
        showNotification('error', 'Table Load Error', `Failed to fetch data for ${currentTable}.`);
      }
    }

    function generateTableHtml(data) {
      if (!data || data.length === 0) {
        return '<div class="table-loading">No data available</div>';
      }

      // Get column names from first row and filter out sensitive columns
      const allColumns = Object.keys(data[0]);
      const sensitiveColumns = ['ip_address', 'user_agent', 'raw_data'];
      const columns = allColumns.filter(col => !sensitiveColumns.includes(col));

      let html = '<table class="data-table"><thead><tr>';
      columns.forEach(col => {
        let displayName = col.replace(/_/g, ' ').toUpperCase();
        // Make column names more user-friendly
        if (col === 'session_id') displayName = 'SESSION';
        if (col === 'page_path') displayName = 'PAGE';
        if (col === 'created_at') displayName = 'TIME';
        if (col === 'callsign') displayName = 'CALLSIGN';
        if (col === 'destination') displayName = 'DEST';
        if (col === 'flight_level') displayName = 'FL';
        html += `<th>${displayName}</th>`;
      });
      html += '</tr></thead><tbody>';

      data.forEach(row => {
        html += '<tr>';
        columns.forEach(col => {
          let value = row[col];

          // Format different data types
          if (value === null || value === undefined) {
            value = '-';
          } else if (typeof value === 'object') {
            value = JSON.stringify(value);
          } else if (typeof value === 'string' && value.length > 50) {
            const escapedValue = escapeHtml(value);
            value = `<span class="table-cell-truncated" onclick='showInfoPopup(${JSON.stringify(value)})'>${escapedValue}</span>`;
          } else if (col.includes('_at') || col.includes('timestamp')) {
            // Format dates
            try {
              const date = new Date(value);
              value = date.toLocaleString();
            } catch (e) {
              // Keep original value if date parsing fails
            }
          } else if (col === 'session_id' && typeof value === 'string') {
            // Truncate session IDs for privacy
            value = value.substring(0, 8) + '...';
          }

          html += `<td>${value}</td>`;
        });
        html += '</tr>';
      });

      html += '</tbody></table>';
      return html;
    }

    function updatePagination() {
      const pagination = document.getElementById('tablePagination');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');
      const pageInfo = document.getElementById('pageInfo');

      const currentPage = Math.floor(currentOffset / pageSize) + 1;
      const totalPages = Math.ceil(totalRecords / pageSize);

      prevBtn.disabled = currentOffset === 0;
      nextBtn.disabled = currentOffset + pageSize >= totalRecords;

      pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
      pagination.style.display = totalPages > 1 ? 'flex' : 'none';
    }

    async function previousPage() {
      if (currentOffset > 0) {
        currentOffset = Math.max(0, currentOffset - pageSize);
        await fetchTableData();
      }
    }

    async function nextPage() {
      if (currentOffset + pageSize < totalRecords) {
        currentOffset += pageSize;
        await fetchTableData();
      }
    }

    async function refreshCurrentTable() {
      await fetchTableData();
    }

    // Current users functionality
    async function loadCurrentUsers() {
      try {
        const response = await fetch(`/api/admin/current-users`, {
          headers: {
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const data = await response.json();

        // Update stats
        document.getElementById('activeUsersCount').textContent = data.activeCount || 0;
        document.getElementById('memorySessionsCount').textContent = data.memorySessionsCount || 0;
        document.getElementById('supabaseSessionsCount').textContent = data.supabaseSessionsCount || 0;

        // Generate users display
        const usersTable = document.getElementById('currentUsersTable');

        if (!data.users || data.users.length === 0) {
          usersTable.innerHTML = '<div class="table-loading">No active users in the last 5 minutes</div>';
          return;
        }

        let usersHtml = '<div class="current-users-grid">';

        data.users.forEach(user => {
          const lastActivity = new Date(user.last_activity);
          const timeAgo = getTimeAgo(lastActivity);

          usersHtml += `
            <div class="user-card">
              <div class="user-card-header">
                <span class="user-session-id">${user.session_id}</span>
                <span class="user-source ${user.source}">${user.source}</span>
              </div>
              <div class="user-stats">
                <div class="user-stat">
                  <div class="user-stat-value">${user.page_views || 0}</div>
                  <div class="user-stat-label">Page Views</div>
                </div>
                <div class="user-stat">
                  <div class="user-stat-value">${user.clearances_generated || 0}</div>
                  <div class="user-stat-label">Clearances</div>
                </div>
              </div>
              <div class="user-last-activity">
                Last activity: ${timeAgo}
              </div>
            </div>
          `;
        });

        usersHtml += '</div>';
        usersTable.innerHTML = usersHtml;

      } catch (error) {
        console.error('Error loading current users:', error);
        document.getElementById('currentUsersTable').innerHTML = '<div class="table-loading">Error loading current users</div>';
      }
    }

    function getTimeAgo(date) {
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);

      if (diffMins < 1) {
        return 'Just now';
      } else if (diffMins < 60) {
        return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
      } else if (diffHours < 24) {
        return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
      } else {
        return date.toLocaleString();
      }
    }

    // User Management Functions
    async function loadCurrentAdminInfo() {
      try {
        const currentAdminDiv = document.getElementById('currentAdminInfo');
        if (currentUser) {
          currentAdminDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 15px;">
              ${currentUser.avatar ? `<img src="${currentUser.avatar}" alt="Avatar" style="width: 50px; height: 50px; border-radius: 50%; border: 2px solid var(--primary-color);">` : ''}
              <div style="flex: 1;">
                <div style="font-size: 18px; font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">
                  ${currentUser.username}
                </div>
                <div style="color: var(--text-muted); font-size: 14px;">
                  Discord ID: ${currentUser.discord_id} | Email: ${currentUser.email || 'N/A'}
                </div>
                <div style="color: var(--text-muted); font-size: 12px; margin-top: 5px;">
                  Roles: ${currentUser.roles ? currentUser.roles.join(', ') : 'admin'}
                </div>
              </div>
              <div style="padding: 8px 16px; background: var(--primary-color); color: #000; border-radius: 6px; font-size: 12px; font-weight: 600;">
                ADMIN ACCESS
              </div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load current admin info:', error);
      }
    }

    async function loadAdminUsers() {
      try {
        const response = await fetch('/api/admin/users', {
          headers: {
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });

        if (response.ok) {
          const data = await response.json();
          displayAdminUsers(data.users || []);
        } else {
          document.getElementById('adminUsersList').innerHTML = `
            <div style="padding: 20px; text-align: center; color: #ff6b6b;">
              Failed to load admin users
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load admin users:', error);
        document.getElementById('adminUsersList').innerHTML = `
          <div style="padding: 20px; text-align: center; color: #ff6b6b;">
            Error loading admin users
          </div>
        `;
      }
    }

    function displayAdminUsers(users) {
      const container = document.getElementById('adminUsersList');

      if (users.length === 0) {
        container.innerHTML = `
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            No admin users found
          </div>
        `;
        return;
      }

      let html = '<div style="padding: 20px;">';
      users.forEach(user => {
        html += `
          <div style="display: flex; align-items: center; gap: 15px; padding: 15px; background: var(--surface-hover); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 15px;">
            ${user.avatar ? `<img src="${user.avatar}" alt="Avatar" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-color);">` : ''}
            <div style="flex: 1;">
              <div style="font-weight: 600; color: var(--text-color); margin-bottom: 3px;">
                ${user.username}
              </div>
              <div style="color: var(--text-muted); font-size: 12px;">
                Discord ID: ${user.discord_id} | Last login: ${new Date(user.last_login).toLocaleDateString()}
              </div>
              <div style="color: var(--text-muted); font-size: 11px; margin-top: 3px;">
                Roles: ${user.roles ? user.roles.join(', ') : 'admin'}
              </div>
            </div>
            <div style="display: flex; gap: 8px;">
              ${user.discord_id !== currentUser.discord_id ? `
                <button class="nav-btn" onclick="removeAdminUser('${user.id}')" style="margin: 0; padding: 6px 12px; font-size: 12px; background: #ff6b6b; border-color: #ff6b6b; color: white;">
                  Remove
                </button>
              ` : `
                <span style="color: var(--primary-color); font-size: 12px; font-weight: 600; padding: 6px 12px;">
                  YOU
                </span>
              `}
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    async function addAdminUser() {
      const username = document.getElementById('newAdminUsername').value.trim();
      const isAdmin = document.getElementById('roleAdmin').checked;
      const isSuperAdmin = document.getElementById('roleSuperAdmin').checked;

      if (!username) {
        showNotification('error', 'Validation Error', 'Please enter a Discord username');
        return;
      }

      const roles = [];
      if (isAdmin) roles.push('admin');
      if (isSuperAdmin) roles.push('super_admin');

      try {
        const response = await fetch('/api/admin/users', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          },
          body: JSON.stringify({
            username: username,
            roles: roles
          })
        });

        const data = await response.json();

        if (response.ok && data.success) {
          showNotification('success', 'User Added', `${username} has been granted admin access`);
          clearAddUserForm();
          loadAdminUsers();
        } else {
          showNotification('error', 'Add Failed', data.error || 'Failed to add admin user');
        }
      } catch (error) {
        console.error('Error adding admin user:', error);
        showNotification('error', 'Network Error', 'Failed to connect to server');
      }
    }

    async function removeAdminUser(userId) {
      if (!confirm('Are you sure you want to remove this admin user? This cannot be undone.')) {
        return;
      }

      try {
        const response = await fetch(`/api/admin/users/${userId}`, {
          method: 'DELETE',
          headers: {
            'X-Session-ID': sessionId,
            'Authorization': `Bearer ${sessionId}`
          }
        });

        const data = await response.json();

        if (response.ok && data.success) {
          showNotification('success', 'User Removed', 'Admin user has been removed');
          loadAdminUsers();
        } else {
          showNotification('error', 'Remove Failed', data.error || 'Failed to remove admin user');
        }
      } catch (error) {
        console.error('Error removing admin user:', error);
        showNotification('error', 'Network Error', 'Failed to connect to server');
      }
    }

    function clearAddUserForm() {
      document.getElementById('newAdminUsername').value = '';
      document.getElementById('roleAdmin').checked = true;
      document.getElementById('roleSuperAdmin').checked = false;
    }

    function showRemoveAdminDialog() {
      // This could be enhanced with a proper modal dialog
      const username = prompt('Enter the Discord username of the admin user to remove:');
      if (username) {
        // In a real implementation, you'd look up the user ID first
        showNotification('info', 'Feature Coming Soon', 'Use the Remove button next to each user in the list above');
      }
    }

    // Auto-refresh analytics every 30 seconds
    setInterval(() => {
      if (sessionId && document.getElementById('analytics').classList.contains('active')) {
        loadAnalytics();
      }
    }, 30000);

    // Auto-refresh debug logs every 15 seconds when system section is active
    setInterval(() => {
      if (sessionId && document.getElementById('system').classList.contains('active')) {
        loadDebugLogs();
      }
    }, 15000);

    // Auto-refresh tables and current users every 10 seconds when tables section is active
    setInterval(() => {
      if (sessionId && document.getElementById('tables').classList.contains('active')) {
        loadCurrentUsers();
      }
    }, 10000);

    // Auto-refresh user management every 30 seconds when users section is active
    setInterval(() => {
      if (sessionId && document.getElementById('users').classList.contains('active')) {
        loadAdminUsers();
      }
    }, 30000);

    // Initialize admin panel
    document.addEventListener('DOMContentLoaded', () => {
      checkAuthParams();
      checkAuthStatus();
    });
  </script>
</body>
</html>