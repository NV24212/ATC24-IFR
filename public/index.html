<!DOCTYPE html>
<html>
<head>
  <title>ATC24 IFR Clearance Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ATC24 IFR Clearance Generator</h1>
    <p style="color: var(--text-muted); margin-top: 15px; font-size: 12px;">
      All rights reserved, Hasan Mahmood © |
      <a href="/license" style="color: var(--primary-color); text-decoration: none;">License</a>
    </p>
  </div>

  <div class="main-grid">
    <div class="section">
      <h2 class="section-title">Flight Plans</h2>
      <button class="refresh-btn" onclick="loadFlightPlans()">Refresh Plans</button>
      <div class="flight-plans" id="flightPlans">
        <div class="no-plans">No flight plans received yet...</div>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">ATC Configuration</h2>

      <div class="config-group">
        <label class="config-label">ATC Call Sign</label>
        <input type="text" id="groundCallsign" placeholder="e.g., EBBR_GND">
      </div>

      <div class="config-group">
        <label class="config-label">ATIS Information Letter</label>
        <select id="atisInfo">
          <option value="A">Information A</option>
          <option value="B">Information B</option>
          <option value="C">Information C</option>
          <option value="D">Information D</option>
          <option value="E">Information E</option>
          <option value="F">Information F</option>
          <option value="G">Information G</option>
          <option value="H">Information H</option>
          <option value="I">Information I</option>
          <option value="J">Information J</option>
          <option value="K">Information K</option>
          <option value="L">Information L</option>
          <option value="M">Information M</option>
          <option value="N">Information N</option>
          <option value="O">Information O</option>
          <option value="P">Information P</option>
          <option value="Q">Information Q</option>
          <option value="R">Information R</option>
          <option value="S">Information S</option>
          <option value="T">Information T</option>
          <option value="U">Information U</option>
          <option value="V">Information V</option>
          <option value="W">Information W</option>
          <option value="X">Information X</option>
          <option value="Y">Information Y</option>
          <option value="Z">Information Z</option>
        </select>
      </div>

      <div class="config-group">
        <label class="config-label">Routing Type</label>
        <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">
          Select departure routing method. As Filed uses the original flight plan route.
        </p>
        <select id="routingType" onchange="handleRoutingTypeChange()">
          <option value="AS_FILED">Use original filed route</option>
          <option value="SID">SID (Standard Instrument Departure)</option>
          <option value="RDV">Radar Vectors (Controller guidance)</option>
          <option value="DIRECT">Direct (Navigation to specific waypoint)</option>
        </select>

        <div id="sidInput" style="display: none; margin-top: 15px;">
          <input type="text" id="sidName" placeholder="Enter SID (e.g., CIV1K)">
        </div>

        <div id="directInput" style="display: none; margin-top: 15px;">
          <input type="text" id="directWaypoint" placeholder="Enter directed waypoint(s) (e.g., BIMBO, ALPHA)">
        </div>
      </div>

      <div class="config-group">
        <label class="config-label">Departure Runway</label>
        <input type="text" id="departureRunway" placeholder="e.g., 25R">
      </div>

      <div class="config-group">
        <label class="config-label">Initial Climb Altitude</label>
        <select id="ifl">
          <option value="1000">1000FT</option>
          <option value="2000">2000FT</option>
          <option value="3000">3000FT</option>
        </select>
      </div>

      <button class="generate-btn" onclick="generateClearance()" id="generateBtn" disabled>
        Generate IFR Clearance
      </button>
    </div>
  </div>

  <div class="section">
    <div class="section-header" onclick="toggleAdvancedConfig()">
      <h2 class="section-title">Advanced Configuration</h2>
      <button class="collapse-toggle" id="advancedToggle">▼</button>
    </div>

    <div class="advanced-config-content collapsed" id="advancedConfigContent">
      <div class="advanced-config-grid">
      <div class="config-section">
        <h3 class="config-section-title">Clearance Format & Phraseology</h3>

        <div class="config-group">
          <label class="config-label">Phraseology Standard</label>
          <select id="userPhraseologyStyle" onchange="updateUserPhraseologyTemplate()">
            <option value="ICAO">ICAO Standard</option>
            <option value="FAA">FAA Standard</option>
            <option value="Local">Local Adaptation</option>
          </select>
        </div>

        <div class="config-group">
          <label class="config-label">Custom Phraseology Format</label>
          <textarea id="userPhraseologyTemplate" placeholder="Enter custom clearance format template...">{CALLSIGN}, {ATC_STATION}, good day. Startup approved. Information {ATIS} is correct. Cleared to {DESTINATION} via {ROUTE}, runway {RUNWAY}. Initial climb {INITIAL_ALT}FT, expect further climb to Flight Level {FLIGHT_LEVEL}. Squawk {SQUAWK}.</textarea>
          <div class="template-help">
            Available variables: {CALLSIGN}, {ATC_STATION}, {ATIS}, {DESTINATION}, {ROUTE}, {RUNWAY}, {INITIAL_ALT}, {FLIGHT_LEVEL}, {SQUAWK}
          </div>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="userIncludeAtis" checked>
            <label for="userIncludeAtis">Include ATIS Information</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="userIncludeSquawk" checked>
            <label for="userIncludeSquawk">Include Squawk Code</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="userIncludeFlightLevel" checked>
            <label for="userIncludeFlightLevel">Include Expected Flight Level</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="userIncludeStartupApproval" checked>
            <label for="userIncludeStartupApproval">Include Startup Approval</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="userIncludeInitialClimb" checked>
            <label for="userIncludeInitialClimb">Include Initial Climb Instruction</label>
          </div>
        </div>
      </div>

      <div class="config-section">
        <h3 class="config-section-title">Aviation Standards</h3>

        <div class="config-group">
          <label class="config-label">Custom Altitudes (comma-separated)</label>
          <input type="text" id="userDefaultAltitudes" placeholder="1000,2000,3000,4000,5000">
          <div class="template-help">
            Enter custom altitude options for initial climb
          </div>
        </div>

        <div class="config-group">
          <label class="config-label">Squawk Code Range (Min)</label>
          <input type="number" id="userSquawkMin" placeholder="1000" min="1000" max="7777" value="1000">
        </div>

        <div class="config-group">
          <label class="config-label">Squawk Code Range (Max)</label>
          <input type="number" id="userSquawkMax" placeholder="7777" min="1000" max="7777" value="7777">
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="userEnableRunwayValidation">
            <label for="userEnableRunwayValidation">Enable Runway Format Validation</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="userEnableSIDValidation">
            <label for="userEnableSIDValidation">Enable SID/STAR Validation</label>
          </div>
        </div>
      </div>
    </div>

      <button class="advanced-save-btn" onclick="saveUserSettings()">Save Configuration</button>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">IFR Clearance</h2>
    <div class="clearance-output" id="clearanceOutput">
      Select a flight plan and configure ATC settings to generate clearance...
    </div>
  </div>
</div>

<script>
  let selectedFlightPlan = null;
  let flightPlans = []; // This will hold flight plans fetched from the server
  let adminSettings = {
    clearanceFormat: {
      includeAtis: true,
      includeSquawk: true,
      includeFlightLevel: true,
      phraseologyStyle: "ICAO",
      includeStartupApproval: true,
      includeInitialClimb: true
    },
    aviation: {
      defaultAltitudes: [1000, 2000, 3000, 4000, 5000],
      squawkRanges: { min: 1000, max: 7777, exclude: [7500, 7600, 7700] }
    }
  };

  // User settings (overrides admin settings)
  let userSettings = {
    clearanceFormat: {
      phraseologyStyle: "ICAO",
      customTemplate: "",
      includeAtis: true,
      includeSquawk: true,
      includeFlightLevel: true,
      includeStartupApproval: true,
      includeInitialClimb: true
    },
    aviation: {
      defaultAltitudes: [],
      squawkRanges: { min: 1000, max: 7777 },
      enableRunwayValidation: false,
      enableSIDValidation: false
    }
  };

  // Notification system
  function showNotification(message, type = 'success') {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    // Trigger animation
    setTimeout(() => notification.classList.add('show'), 100);

    // Auto-remove after 3 seconds
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => document.body.removeChild(notification), 400);
    }, 3000);
  }

  // Load user settings from localStorage
  function loadUserSettings() {
    try {
      const saved = localStorage.getItem('atc24_user_settings');
      if (saved) {
        const parsed = JSON.parse(saved);
        userSettings = { ...userSettings, ...parsed };
      }
      // Always update UI after loading (or not loading) settings
      updateUserSettingsUI();
    } catch (error) {
      console.error('Failed to load user settings:', error);
      // Still update UI with defaults on error
      updateUserSettingsUI();
    }
  }

  // Save user settings to localStorage
  function saveUserSettings() {
    try {
      // Get values from UI
      userSettings.clearanceFormat.phraseologyStyle = document.getElementById('userPhraseologyStyle').value;
      userSettings.clearanceFormat.customTemplate = document.getElementById('userPhraseologyTemplate').value;
      userSettings.clearanceFormat.includeAtis = document.getElementById('userIncludeAtis').checked;
      userSettings.clearanceFormat.includeSquawk = document.getElementById('userIncludeSquawk').checked;
      userSettings.clearanceFormat.includeFlightLevel = document.getElementById('userIncludeFlightLevel').checked;
      userSettings.clearanceFormat.includeStartupApproval = document.getElementById('userIncludeStartupApproval').checked;
      userSettings.clearanceFormat.includeInitialClimb = document.getElementById('userIncludeInitialClimb').checked;

      // Aviation settings
      const altitudesText = document.getElementById('userDefaultAltitudes').value.trim();
      if (altitudesText) {
        userSettings.aviation.defaultAltitudes = altitudesText.split(',').map(n => parseInt(n.trim())).filter(n => !isNaN(n));
      }
      userSettings.aviation.squawkRanges.min = parseInt(document.getElementById('userSquawkMin').value) || 1000;
      userSettings.aviation.squawkRanges.max = parseInt(document.getElementById('userSquawkMax').value) || 7777;
      userSettings.aviation.enableRunwayValidation = document.getElementById('userEnableRunwayValidation').checked;
      userSettings.aviation.enableSIDValidation = document.getElementById('userEnableSIDValidation').checked;

      // Save to localStorage
      localStorage.setItem('atc24_user_settings', JSON.stringify(userSettings));

      // Update UI elements that depend on settings
      updateUIFromSettings();

      showNotification('Configuration saved successfully!', 'success');
    } catch (error) {
      console.error('Failed to save user settings:', error);
      showNotification('Failed to save configuration', 'error');
    }
  }

  // Update UI elements with user settings
  function updateUserSettingsUI() {
    document.getElementById('userPhraseologyStyle').value = userSettings.clearanceFormat.phraseologyStyle;

    // Set custom template or default template if empty
    const templateValue = userSettings.clearanceFormat.customTemplate || getDefaultTemplate(userSettings.clearanceFormat.phraseologyStyle);
    document.getElementById('userPhraseologyTemplate').value = templateValue;

    document.getElementById('userIncludeAtis').checked = userSettings.clearanceFormat.includeAtis;
    document.getElementById('userIncludeSquawk').checked = userSettings.clearanceFormat.includeSquawk;
    document.getElementById('userIncludeFlightLevel').checked = userSettings.clearanceFormat.includeFlightLevel;
    document.getElementById('userIncludeStartupApproval').checked = userSettings.clearanceFormat.includeStartupApproval;
    document.getElementById('userIncludeInitialClimb').checked = userSettings.clearanceFormat.includeInitialClimb;

    if (userSettings.aviation.defaultAltitudes && userSettings.aviation.defaultAltitudes.length > 0) {
      document.getElementById('userDefaultAltitudes').value = userSettings.aviation.defaultAltitudes.join(',');
    }
    document.getElementById('userSquawkMin').value = userSettings.aviation.squawkRanges.min;
    document.getElementById('userSquawkMax').value = userSettings.aviation.squawkRanges.max;
    document.getElementById('userEnableRunwayValidation').checked = userSettings.aviation.enableRunwayValidation;
    document.getElementById('userEnableSIDValidation').checked = userSettings.aviation.enableSIDValidation;
  }

  // Get default template based on phraseology style
  function getDefaultTemplate(style) {
    switch(style) {
      case 'ICAO':
        return '{CALLSIGN}, {ATC_STATION}, good day. Startup approved. Information {ATIS} is correct. Cleared to {DESTINATION} via {ROUTE}, runway {RUNWAY}. Initial climb {INITIAL_ALT}FT, expect further climb to Flight Level {FLIGHT_LEVEL}. Squawk {SQUAWK}.';
      case 'FAA':
        return '{CALLSIGN}, {ATC_STATION}. Cleared to {DESTINATION} airport via {ROUTE}, runway {RUNWAY}. Climb and maintain {INITIAL_ALT}, expect {FLIGHT_LEVEL} 10 minutes after departure. Departure frequency will be as published. Squawk {SQUAWK}.';
      case 'Local':
        return '{CALLSIGN}, {ATC_STATION}. You are cleared to {DESTINATION} via {ROUTE}, departing runway {RUNWAY}. Climb initially to {INITIAL_ALT} feet, expect flight level {FLIGHT_LEVEL}. Squawk {SQUAWK}. Contact ground for pushback.';
      default:
        return '{CALLSIGN}, {ATC_STATION}, good day. Startup approved. Information {ATIS} is correct. Cleared to {DESTINATION} via {ROUTE}, runway {RUNWAY}. Initial climb {INITIAL_ALT}FT, expect further climb to Flight Level {FLIGHT_LEVEL}. Squawk {SQUAWK}.';
    }
  }

  // Update user phraseology template when style changes
  function updateUserPhraseologyTemplate() {
    const style = document.getElementById('userPhraseologyStyle').value;
    const templateField = document.getElementById('userPhraseologyTemplate');
    templateField.value = getDefaultTemplate(style);
  }

  // Get effective settings (user settings override admin settings)
  function getEffectiveSettings() {
    const effective = JSON.parse(JSON.stringify(adminSettings)); // Deep clone

    // Override with user settings
    if (userSettings.clearanceFormat.customTemplate) {
      effective.clearanceFormat.customTemplate = userSettings.clearanceFormat.customTemplate;
    }
    if (userSettings.clearanceFormat.phraseologyStyle) {
      effective.clearanceFormat.phraseologyStyle = userSettings.clearanceFormat.phraseologyStyle;
    }
    effective.clearanceFormat.includeAtis = userSettings.clearanceFormat.includeAtis;
    effective.clearanceFormat.includeSquawk = userSettings.clearanceFormat.includeSquawk;
    effective.clearanceFormat.includeFlightLevel = userSettings.clearanceFormat.includeFlightLevel;
    effective.clearanceFormat.includeStartupApproval = userSettings.clearanceFormat.includeStartupApproval;
    effective.clearanceFormat.includeInitialClimb = userSettings.clearanceFormat.includeInitialClimb;

    if (userSettings.aviation.defaultAltitudes && userSettings.aviation.defaultAltitudes.length > 0) {
      effective.aviation.defaultAltitudes = userSettings.aviation.defaultAltitudes;
    }
    effective.aviation.squawkRanges.min = userSettings.aviation.squawkRanges.min;
    effective.aviation.squawkRanges.max = userSettings.aviation.squawkRanges.max;

    return effective;
  }

  function handleRoutingTypeChange() {
    const routingType = document.getElementById("routingType").value;
    const sidInput = document.getElementById("sidInput");
    const directInput = document.getElementById("directInput");

    // Hide all inputs first
    sidInput.style.display = "none";
    directInput.style.display = "none";

    // Show relevant input based on selection
    if (routingType === "SID") {
      sidInput.style.display = "block";
    } else if (routingType === "DIRECT") {
      directInput.style.display = "block";
    }
  }

  function generateSquawk() {
    const effectiveSettings = getEffectiveSettings();
    const min = effectiveSettings.aviation.squawkRanges.min;
    const max = effectiveSettings.aviation.squawkRanges.max;
    const exclude = effectiveSettings.aviation.squawkRanges.exclude || [7500, 7600, 7700];

    while (true) {
      let code = Math.floor(min + Math.random() * (max - min + 1)).toString();

      // Ensure all digits are between 0-7 for octal squawk code
      if ([...code].every(c => parseInt(c) <= 7) && !exclude.includes(parseInt(code))) {
        return code;
      }
    }
  }

  async function loadFlightPlans() {
    try {
      // Add loading state
      const flightPlansContainer = document.getElementById("flightPlans");
      flightPlansContainer.innerHTML = '<div class="no-plans loading">Loading flight plans...</div>';

      const res = await fetch("/flight-plans");
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      flightPlans = await res.json();
      displayFlightPlans();
    } catch (err) {
      console.error("Failed to load flight plans:", err);
      document.getElementById("flightPlans").innerHTML =
        '<div class="no-plans">Failed to connect to server or no plans available.</div>';
    }
  }

  function displayFlightPlans() {
    const container = document.getElementById("flightPlans");

    if (flightPlans.length === 0) {
      container.innerHTML = '<div class="no-plans">No flight plans received yet...</div>';
      return;
    }

    container.innerHTML = flightPlans.map((plan, index) => `
      <div class="flight-plan ${selectedFlightPlan === plan ? 'selected' : ''}" onclick="selectFlightPlan(${index})">
        <div class="flight-plan-callsign">${plan.callsign || 'Unknown'}</div>
        <div class="flight-plan-details">
          Destination: ${plan.arriving || 'N/A'}<br>
          Route: ${plan.route || 'Direct'}<br>
          FL: ${plan.flightlevel || 'N/A'}<br>
          Source: ${plan.source || 'Main'}
        </div>
      </div>
    `).join('');
  }

  function selectFlightPlan(index) {
    selectedFlightPlan = flightPlans[index];
    document.querySelectorAll('.flight-plan').forEach((el, i) => {
      el.classList.toggle('selected', i === index);
    });
    document.getElementById('generateBtn').disabled = false;
  }

  function generateClearance() {
    if (!selectedFlightPlan) {
      alert('Please select a flight plan first');
      return;
    }

    const effectiveSettings = getEffectiveSettings();
    const groundCallsign = document.getElementById("groundCallsign").value.trim() || "GROUND";
    const atisInfo = document.getElementById("atisInfo").value;
    const ifl = document.getElementById("ifl").value;
    const departureRW = document.getElementById("departureRunway").value.trim();
    const routingType = document.getElementById("routingType").value;
    const squawk = generateSquawk();

    // Get details from flight plan
    const callsign = selectedFlightPlan.callsign || 'UNKNOWN';
    const destination = selectedFlightPlan.arriving || 'UNKNOWN';
    const planRoute = selectedFlightPlan.route || '';
    const flightLevel = selectedFlightPlan.flightlevel || 'N/A';

    // Validate inputs
    if (!groundCallsign || groundCallsign === "GROUND") {
      alert('Please enter an ATC Call Sign.');
      return;
    }

    if (!departureRW) {
      alert('Please enter a Departure Runway.');
      return;
    }

    // Runway validation if enabled
    if (effectiveSettings.aviation.enableRunwayValidation && userSettings.aviation.enableRunwayValidation) {
      const runwayPattern = /^[0-3]?[0-9][LRC]?$/i;
      if (!runwayPattern.test(departureRW)) {
        alert('Invalid runway format. Use format like: 25R, 09L, 03C, or 36');
        return;
      }
    }

    // Handle routing based on type
    let routePhrase = '';
    switch (routingType) {
      case 'SID':
        const sidName = document.getElementById("sidName").value.trim();
        if (sidName) {
          // SID validation if enabled
          if (effectiveSettings.aviation.enableSIDValidation && userSettings.aviation.enableSIDValidation) {
            const sidPattern = /^[A-Z0-9]{3,6}$/i;
            if (!sidPattern.test(sidName)) {
              alert('Invalid SID format. Use format like: CIV1K, BIMBO2');
              return;
            }
          }
          routePhrase = `the ${sidName} departure`;
        } else {
          alert('Please enter a SID name.');
          return;
        }
        break;
      case 'RDV':
        routePhrase = 'radar vectors';
        break;
      case 'DIRECT':
        const directWaypoint = document.getElementById("directWaypoint").value.trim();
        if (directWaypoint) {
          routePhrase = `direct ${directWaypoint}`;
        } else {
          alert('Please enter a direct waypoint.');
          return;
        }
        break;
      case 'AS_FILED':
        routePhrase = planRoute || 'as filed';
        break;
      default:
        routePhrase = planRoute || 'as filed';
    }

    // Generate clearance based on user's custom template if available, otherwise use legacy format
    let clearance = '';

    if (effectiveSettings.clearanceFormat.customTemplate && userSettings.clearanceFormat.customTemplate) {
      // Use user's custom template
      clearance = userSettings.clearanceFormat.customTemplate
        .replace('{CALLSIGN}', callsign)
        .replace('{ATC_STATION}', groundCallsign)
        .replace('{ATIS}', atisInfo)
        .replace('{DESTINATION}', destination)
        .replace('{ROUTE}', routePhrase)
        .replace('{RUNWAY}', departureRW)
        .replace('{INITIAL_ALT}', ifl)
        .replace('{FLIGHT_LEVEL}', flightLevel.replace('FL', '').padStart(3, '0'))
        .replace('{SQUAWK}', squawk);
    } else {
      // Fallback to structured clearance generation using effective settings
      let clearanceParts = [];

      // Basic greeting and callsign
      if (effectiveSettings.clearanceFormat.phraseologyStyle === "ICAO") {
        clearanceParts.push(`${callsign}, ${groundCallsign}, good day.`);
      } else if (effectiveSettings.clearanceFormat.phraseologyStyle === "FAA") {
        clearanceParts.push(`${callsign}, ${groundCallsign}.`);
      } else {
        clearanceParts.push(`${callsign}, ${groundCallsign}, good day.`);
      }

      // Startup approval
      if (effectiveSettings.clearanceFormat.includeStartupApproval) {
        clearanceParts.push("Startup approved.");
      }

      // ATIS information
      if (effectiveSettings.clearanceFormat.includeAtis) {
        clearanceParts.push(`Information ${atisInfo} is correct.`);
      }

      // Clearance itself
      clearanceParts.push(`Cleared to ${destination} via ${routePhrase}, runway ${departureRW}.`);

      // Initial climb
      if (effectiveSettings.clearanceFormat.includeInitialClimb) {
        clearanceParts.push(`Initial climb ${ifl}FT`);

        // Expected flight level
        if (effectiveSettings.clearanceFormat.includeFlightLevel && flightLevel !== 'N/A') {
          clearanceParts[clearanceParts.length - 1] += `, expect further climb to Flight Level ${flightLevel.replace('FL', '').padStart(3, '0')}.`;
        } else {
          clearanceParts[clearanceParts.length - 1] += ".";
        }
      }

      // Squawk code
      if (effectiveSettings.clearanceFormat.includeSquawk) {
        clearanceParts.push(`Squawk ${squawk}.`);
      }

      clearance = clearanceParts.join(' ');
    }
    document.getElementById("clearanceOutput").textContent = clearance;

    // Track analytics
    trackClearanceGeneration();
  }

  // Track clearance generation
  async function trackClearanceGeneration() {
    try {
      const clearanceData = {
        callsign: selectedFlightPlan?.callsign,
        destination: selectedFlightPlan?.arriving,
        route: selectedFlightPlan?.route,
        routing_type: document.getElementById("routingType").value,
        runway: document.getElementById("departureRunway").value,
        initial_altitude: parseInt(document.getElementById("ifl").value),
        atc_station: document.getElementById("groundCallsign").value,
        atis_info: document.getElementById("atisInfo").value,
        clearance_text: document.getElementById("clearanceOutput").textContent
      };

      await fetch('/api/clearance-generated', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(clearanceData)
      });
    } catch (error) {
      console.error('Failed to track clearance generation:', error);
    }
  }

  // Load admin settings for the frontend
  async function loadAdminSettings() {
    try {
      const response = await fetch('/api/admin/settings?password=guest');
      if (response.ok) {
        const settings = await response.json();
        if (settings && !settings.error) {
          adminSettings = settings;

          // Update UI based on settings
          updateUIFromSettings();
        }
      }
    } catch (error) {
      console.log('Using default settings');
    }
  }

  // Update UI elements based on effective settings (user settings override admin settings)
  function updateUIFromSettings() {
    const effectiveSettings = getEffectiveSettings();

    // Update default altitudes in the dropdown
    if (effectiveSettings.aviation && effectiveSettings.aviation.defaultAltitudes) {
      const iflSelect = document.getElementById('ifl');
      iflSelect.innerHTML = '';

      effectiveSettings.aviation.defaultAltitudes.forEach(altitude => {
        const option = document.createElement('option');
        option.value = altitude;
        option.textContent = `${altitude}FT`;
        iflSelect.appendChild(option);
      });
    }
  }

  // Environment detection and polling fallback
  let autoRefreshInterval = null;
  let isServerless = false;

  async function checkEnvironmentAndStartPolling() {
    try {
      const healthResponse = await fetch('/health');
      const healthData = await healthResponse.json();
      isServerless = healthData.environment === 'serverless';

      // Initial load
      await loadFlightPlans();

      // Set up polling for serverless or if WebSocket is unavailable
      if (isServerless || !healthData.wsConnected) {
        console.log('Starting polling fallback - Environment:', healthData.environment);
        startPolling(isServerless ? 10000 : 30000); // Poll every 10s for serverless, 30s for WebSocket issues

        // Show notification to user
        if (isServerless) {
          showEnvironmentNotification();
        }
      } else {
        console.log('WebSocket available - using real-time updates');
      }
    } catch (error) {
      console.error('Failed to check environment, using polling fallback:', error);
      await loadFlightPlans();
      startPolling(15000); // Default polling interval
    }
  }

  function startPolling(interval) {
    if (autoRefreshInterval) {
      clearInterval(autoRefreshInterval);
    }

    autoRefreshInterval = setInterval(async () => {
      try {
        await loadFlightPlans();
        console.log('Flight plans refreshed via polling');
      } catch (error) {
        console.error('Polling refresh failed:', error);
      }
    }, interval);
  }

  function showEnvironmentNotification() {
    const notification = document.createElement('div');
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(255, 165, 0, 0.1);
      border: 1px solid rgba(255, 165, 0, 0.3);
      border-radius: 8px;
      padding: 15px 20px;
      max-width: 300px;
      font-size: 14px;
      color: #ffa500;
      z-index: 1000;
      backdrop-filter: blur(10px);
    `;
    notification.innerHTML = `
      <strong>⚠️ Serverless Mode</strong><br>
      <span style="color: var(--text-muted); font-size: 12px;">
        Flight plans update every 10 seconds via polling
      </span>
    `;

    document.body.appendChild(notification);

    // Auto-remove after 8 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 8000);
  }

  // Initial load of flight plans when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    // Load user settings first
    loadUserSettings();

    // Then load admin settings and start polling
    loadAdminSettings().then(() => {
      updateUIFromSettings(); // Update UI with effective settings
      checkEnvironmentAndStartPolling();
    });
  });
</script>

</body>
</html>
