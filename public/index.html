<!DOCTYPE html>
<html>
<head>
  <title>ATC24 IFR Clearance Generator</title>
  <link href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="container">
  <div class="header">
    <h1>ATC24 IFR Clearance Generator</h1>
    <p style="color: var(--text-muted); margin-top: 15px; font-size: 12px;">
      All rights reserved, Hasan Mahmood Â© | <a href="https://atc24-ifr.hasmah.xyz/license" style="color: var(--primary-color); text-decoration: none;">License</a>
    </p>
  </div>

  <div class="main-grid">
    <div class="section">
      <h2 class="section-title">Flight Plans</h2>
      <button class="refresh-btn" onclick="loadFlightPlans()">Refresh Plans</button>
      <div class="flight-plans" id="flightPlans">
        <div class="no-plans">No flight plans received yet...</div>
      </div>
    </div>

    <div class="section">
      <h2 class="section-title">ATC Configuration</h2>

      <div class="config-group">
        <label class="config-label">ATC Call Sign</label>
        <input type="text" id="groundCallsign" placeholder="e.g., EBBR_GND">
      </div>

      <div class="config-group">
        <label class="config-label">ATIS Information Letter</label>
        <select id="atisInfo">
          <option value="A">Information A</option>
          <option value="B">Information B</option>
          <option value="C">Information C</option>
          <option value="D">Information D</option>
          <option value="E">Information E</option>
          <option value="F">Information F</option>
          <option value="G">Information G</option>
          <option value="H">Information H</option>
          <option value="I">Information I</option>
          <option value="J">Information J</option>
          <option value="K">Information K</option>
          <option value="L">Information L</option>
          <option value="M">Information M</option>
          <option value="N">Information N</option>
          <option value="O">Information O</option>
          <option value="P">Information P</option>
          <option value="Q">Information Q</option>
          <option value="R">Information R</option>
          <option value="S">Information S</option>
          <option value="T">Information T</option>
          <option value="U">Information U</option>
          <option value="V">Information V</option>
          <option value="W">Information W</option>
          <option value="X">Information X</option>
          <option value="Y">Information Y</option>
          <option value="Z">Information Z</option>
        </select>
      </div>

      <div class="config-group">
        <label class="config-label">Routing Type</label>
        <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 10px;">
          Select departure routing method. As Filed uses the original flight plan route.
        </p>
        <select id="routingType" onchange="handleRoutingTypeChange()">
          <option value="AS_FILED">Use original filed route</option>
          <option value="SID">SID (Standard Instrument Departure)</option>
          <option value="RDV">Radar Vectors (Controller guidance)</option>
          <option value="DIRECT">Direct (Navigation to specific waypoint)</option>
        </select>

        <div id="sidInput" style="display: none; margin-top: 15px;">
          <input type="text" id="sidName" placeholder="Enter SID (e.g., CIV1K)">
        </div>

        <div id="directInput" style="display: none; margin-top: 15px;">
          <input type="text" id="directWaypoint" placeholder="Enter directed waypoint(s) (e.g., BIMBO, ALPHA)">
        </div>
      </div>

      <div class="config-group">
        <label class="config-label">Departure Runway</label>
        <input type="text" id="departureRunway" placeholder="e.g., 25R">
      </div>

      <div class="config-group">
        <label class="config-label">Initial Climb Altitude</label>
        <select id="ifl">
          <option value="1000">1000FT</option>
          <option value="2000">2000FT</option>
          <option value="3000">3000FT</option>
        </select>
      </div>

      <button class="generate-btn" onclick="generateClearance()" id="generateBtn" disabled>
        Generate IFR Clearance
      </button>
    </div>
  </div>

  <div class="section">
    <h2 class="section-title">IFR Clearance</h2>
    <div class="clearance-output" id="clearanceOutput">
      Select a flight plan and configure ATC settings to generate clearance...
    </div>
  </div>
</div>

<script>
  let selectedFlightPlan = null;
  let flightPlans = []; // This will hold flight plans fetched from the server
  let adminSettings = {
    clearanceFormat: {
      includeAtis: true,
      includeSquawk: true,
      includeFlightLevel: true,
      phraseologyStyle: "ICAO",
      includeStartupApproval: true,
      includeInitialClimb: true
    },
    aviation: {
      defaultAltitudes: [1000, 2000, 3000, 4000, 5000],
      squawkRanges: { min: 1000, max: 7777, exclude: [7500, 7600, 7700] }
    }
  };

  function handleRoutingTypeChange() {
    const routingType = document.getElementById("routingType").value;
    const sidInput = document.getElementById("sidInput");
    const directInput = document.getElementById("directInput");

    // Hide all inputs first
    sidInput.style.display = "none";
    directInput.style.display = "none";

    // Show relevant input based on selection
    if (routingType === "SID") {
      sidInput.style.display = "block";
    } else if (routingType === "DIRECT") {
      directInput.style.display = "block";
    }
  }

  function generateSquawk() {
    const min = adminSettings.aviation.squawkRanges.min;
    const max = adminSettings.aviation.squawkRanges.max;
    const exclude = adminSettings.aviation.squawkRanges.exclude;

    while (true) {
      let code = Math.floor(min + Math.random() * (max - min + 1)).toString();

      // Ensure all digits are between 0-7 for octal squawk code
      if ([...code].every(c => parseInt(c) <= 7) && !exclude.includes(parseInt(code))) {
        return code;
      }
    }
  }

  async function loadFlightPlans() {
    try {
      // Add loading state
      const flightPlansContainer = document.getElementById("flightPlans");
      flightPlansContainer.innerHTML = '<div class="no-plans loading">Loading flight plans...</div>';

      const res = await fetch("/flight-plans");
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      flightPlans = await res.json();
      displayFlightPlans();
    } catch (err) {
      console.error("Failed to load flight plans:", err);
      document.getElementById("flightPlans").innerHTML =
        '<div class="no-plans">Failed to connect to server or no plans available.</div>';
    }
  }

  function displayFlightPlans() {
    const container = document.getElementById("flightPlans");

    if (flightPlans.length === 0) {
      container.innerHTML = '<div class="no-plans">No flight plans received yet...</div>';
      return;
    }

    container.innerHTML = flightPlans.map((plan, index) => `
      <div class="flight-plan ${selectedFlightPlan === plan ? 'selected' : ''}" onclick="selectFlightPlan(${index})">
        <div class="flight-plan-callsign">${plan.callsign || 'Unknown'}</div>
        <div class="flight-plan-details">
          Destination: ${plan.arriving || 'N/A'}<br>
          Route: ${plan.route || 'Direct'}<br>
          FL: ${plan.flightlevel || 'N/A'}<br>
          Source: ${plan.source || 'Main'}
        </div>
      </div>
    `).join('');
  }

  function selectFlightPlan(index) {
    selectedFlightPlan = flightPlans[index];
    document.querySelectorAll('.flight-plan').forEach((el, i) => {
      el.classList.toggle('selected', i === index);
    });
    document.getElementById('generateBtn').disabled = false;
  }

  function generateClearance() {
    if (!selectedFlightPlan) {
      alert('Please select a flight plan first');
      return;
    }

    const groundCallsign = document.getElementById("groundCallsign").value.trim() || "GROUND";
    const atisInfo = document.getElementById("atisInfo").value;
    const ifl = document.getElementById("ifl").value;
    const departureRW = document.getElementById("departureRunway").value.trim();
    const routingType = document.getElementById("routingType").value;
    const squawk = generateSquawk();

    // Get details from flight plan
    const callsign = selectedFlightPlan.callsign || 'UNKNOWN';
    const destination = selectedFlightPlan.arriving || 'UNKNOWN';
    const planRoute = selectedFlightPlan.route || '';
    const flightLevel = selectedFlightPlan.flightlevel || 'N/A';

    // Validate inputs
    if (!groundCallsign || groundCallsign === "GROUND") {
      alert('Please enter an ATC Call Sign.');
      return;
    }

    if (!departureRW) {
      alert('Please enter a Departure Runway.');
      return;
    }

    // Handle routing based on type
    let routePhrase = '';
    switch (routingType) {
      case 'SID':
        const sidName = document.getElementById("sidName").value.trim();
        if (sidName) {
          routePhrase = `the ${sidName} departure`;
        } else {
          alert('Please enter a SID name.');
          return;
        }
        break;
      case 'RDV':
        routePhrase = 'radar vectors';
        break;
      case 'DIRECT':
        const directWaypoint = document.getElementById("directWaypoint").value.trim();
        if (directWaypoint) {
          routePhrase = `direct ${directWaypoint}`;
        } else {
          alert('Please enter a direct waypoint.');
          return;
        }
        break;
      case 'AS_FILED':
        routePhrase = planRoute || 'as filed';
        break;
      default:
        routePhrase = planRoute || 'as filed';
    }

    // Generate clearance based on admin settings and phraseology style
    let clearanceParts = [];

    // Basic greeting and callsign
    if (adminSettings.clearanceFormat.phraseologyStyle === "ICAO") {
      clearanceParts.push(`${callsign}, ${groundCallsign}, good day.`);
    } else if (adminSettings.clearanceFormat.phraseologyStyle === "FAA") {
      clearanceParts.push(`${callsign}, ${groundCallsign}.`);
    } else {
      clearanceParts.push(`${callsign}, ${groundCallsign}, good day.`);
    }

    // Startup approval
    if (adminSettings.clearanceFormat.includeStartupApproval) {
      clearanceParts.push("Startup approved.");
    }

    // ATIS information
    if (adminSettings.clearanceFormat.includeAtis) {
      clearanceParts.push(`Information ${atisInfo} is correct.`);
    }

    // Clearance itself
    clearanceParts.push(`Cleared to ${destination} via ${routePhrase}, runway ${departureRW}.`);

    // Initial climb
    if (adminSettings.clearanceFormat.includeInitialClimb) {
      clearanceParts.push(`Initial climb ${ifl}FT`);

      // Expected flight level
      if (adminSettings.clearanceFormat.includeFlightLevel && flightLevel !== 'N/A') {
        clearanceParts[clearanceParts.length - 1] += `, expect further climb to Flight Level ${flightLevel.replace('FL', '').padStart(3, '0')}.`;
      } else {
        clearanceParts[clearanceParts.length - 1] += ".";
      }
    }

    // Squawk code
    if (adminSettings.clearanceFormat.includeSquawk) {
      clearanceParts.push(`Squawk ${squawk}.`);
    }

    const clearance = clearanceParts.join(' ');
    document.getElementById("clearanceOutput").textContent = clearance;

    // Track analytics
    trackClearanceGeneration();
  }

  // Initial load of flight plans when the page loads
  document.addEventListener('DOMContentLoaded', () => {
    loadFlightPlans();
  });
</script>

</body>
</html>
